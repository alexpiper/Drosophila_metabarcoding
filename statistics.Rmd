---
title: "Drosophila Metabarcoding"
title: "Statistical analysis"
author: "Alexander Piper"
date: "`r Sys.Date()`"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

# Introduction

## Analysis structure

Part 1 - Cleanup & Filtering of index switching

Part 1 - Comparison of 4 primers for bias and detection efficiency (figure 1)

Part 2 - Comparison of bias between 3 tagged primers

Part 3 - Comparison

## Load packages

```{r setup}
#Set required packages
.cran_packages <- c("tidyverse",
                    "tidymodels",
                    "patchwork", 
                    "vegan", 
                    "seqinr",
                    "ape", 
                    "RColorBrewer",
                    "castor", 
                    "picante",
                    "phytools",
                    "ggrepel",
                    "devtools",
                    "ggnewscale",
                    "ggpubr")
.bioc_packages <- c("dada2",
                    "phyloseq", 
                    "ggtree",
                    "DECIPHER",
                    "Biostrings",
                    "ShortRead", 
                    "philr",
                    "ALDEx2")

.inst <- .cran_packages %in% installed.packages()
if(any(!.inst)) {
   install.packages(.cran_packages[!.inst])
}
.inst <- .bioc_packages %in% installed.packages()
if(any(!.inst)) {
  if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
  BiocManager::install(.bioc_packages[!.inst], ask = F)
}

sapply(c(.cran_packages,.bioc_packages), require, character.only = TRUE)

# Github packages
devtools::install_github("alexpiper/taxreturn")
devtools::install_github("alexpiper/seqateurs")
devtools::install_github("mikemc/speedyseq")
devtools::install_github('ggloor/CoDaSeq/CoDaSeq')
devtools::install_github("mikemc/metacal")

library(speedyseq)
library(taxreturn)
library(seqateurs)
library(CoDaSeq)
library(metacal)

#Source internal functions
source('R/helper_functions.R')

#Source themes
source('R/themes.R')
```

## Read in phyloseq object

```{r phyloseq}
ps1 <- readRDS("output/rds/ps1.rds")
```


## Replicate observations and overlap

```{r Replicates}
# Abundance counts for different replicates
# Load in all samples that were expected
exp_samples <- read_csv("data/HLVKYDMXX/SampleSheet.csv", skip = 19) %>%
  dplyr::select(extract_id = Sample_Name, sample_name = Sample_Name) %>%
  group_by(extract_id) %>%
  #group_split() %>%
  group_modify(~{
    .x %>%
      dplyr::slice(rep(1:n(), each=3)) %>%
      mutate(amp_rep = row_number()) %>%
      mutate(sample_id = paste0(sample_name, "_", amp_rep))
  }) %>%
  ungroup() %>%
  mutate(sample_name = extract_id %>%
           str_remove("-ex[0-9]$"))%>%
  mutate(type = case_when(
    str_detect(sample_id, "D[0-9][0-9][0-9]M|D[0-9][0-9][0-9][0-9]M|DM[0-9]")  ~ "DrosMock",
    str_detect(sample_id, "SPD")  ~ "SPD",
    str_detect(sample_id, "ACV")  ~ "ACV",
    str_detect(sample_id, "DC")  ~ "DC",
    str_detect(sample_id, "Sach")  ~ "Sachet",
    str_detect(sample_id, "FF")  ~ "FF",
    str_detect(sample_id, "NTC")  ~ "NTC",
    str_detect(sample_id, "DLarv")  ~ "DrosLarv",
    str_detect(sample_id, "POS|SynMock")  ~ "POS",
    str_detect(sample_id, "extblank|BLANK")  ~ "Extblank",
    str_detect(sample_id, "pcrblank")  ~ "PCRblank",
    str_detect(sample_id, "CT")  ~ "CarpTrap",
    str_detect(sample_id, "CM[0-9]")  ~ "CarpMock",
    str_detect(sample_id, "CML[0-9]")  ~ "CarpLarval"
  )) %>%
  filter(type %in% c("DrosMock", "DrosLarv", "ACV", "DC", "SPD", "FF", "POS", "SPD"))
  
  
# Heatmap of abundance of pcr replicates
rep_data <- exp_samples %>%
  left_join(ps1 %>% 
  speedyseq::psmelt() %>%
    filter(fcid=="HLVKYDMXX", Abundance > 0) %>%
    group_by(sample_name, extract_id, sample_id, amp_rep, fcid) %>%
    summarise(Abundance = sum(Abundance), n_spp = n_distinct(Species)) %>%
    ungroup()) %>%
  filter(!str_detect(sample_name, "_DM1$|_DM2$|_DM3$|_DM4$|_DM5$")) %>%
  mutate(extrep = extract_id %>% str_extract("ex.*$")) %>%
  mutate(type = type %>% 
           str_replace("DrosMock", "Adult Mock") %>%
           str_replace("DrosLarv", "Larval Mock") %>%
           factor(levels=c("POS", "Adult Mock", "Larval Mock","FF","SPD", "DC", "ACV"))) %>%
  mutate(sample_name = sample_name %>%
           str_remove("HLVKYDMXX_") %>%
           str_replace("^D2","D02") %>%
           str_replace("^D5","D05")) %>%
  #filter(!(extrep=="ex1" & amp_rep == 2)) %>%
  mutate(amp_rep = factor(amp_rep)) %>%
  mutate(extrep = extrep %>% str_replace("ex", "Extraction Rep "))

# Summarise of replicate success
rep_data %>%
  ungroup() %>%
  mutate(success = case_when(
    Abundance > 0 ~ TRUE,
    Abundance == 0 | is.na(Abundance) ~ FALSE
  )) %>%
  group_by(type) %>%
  summarise(sum=sum(success), total = n()) %>%
  mutate(proportion = sum / total)

# Summary of sample success
rep_data %>%
  ungroup() %>%
  group_by(sample_name, type) %>%
  summarise(Abundance = sum(Abundance, na.rm = TRUE))%>%
  ungroup() %>%
  mutate(success = case_when(
    Abundance > 0 ~ TRUE,
    Abundance == 0 | is.na(Abundance) ~ FALSE
  )) %>%
  group_by(type) %>%
  summarise(sum=sum(success), total = n()) %>%
  mutate(proportion = sum / total)


gg.repmap <- rep_data %>%
   ggplot(aes(x = amp_rep, y = sample_name, fill = n_spp)) +
  geom_tile()+
  scale_fill_viridis_c()+
  facet_grid(extrep~type, scales="free", space="free", drop=TRUE)+
  base_theme+
  scale_x_discrete(expand=c(0,0))+
  scale_y_discrete(expand=c(0,0))+
  coord_flip()+
  theme(axis.text.x = element_blank(),
        legend.position = "top")+
  labs(x = "PCR Replicate",
       y = NULL,
       fill = "N Species")

gg.repmap

# What species are different between samples
test <- ps1 %>% 
  speedyseq::psmelt() %>%
  filter(fcid=="HLVKYDMXX", Abundance > 0) %>%
  dplyr::select(OTU, sample_name, sample_id, extract_id, Species, Abundance) %>%
  distinct() %>%
  group_by(sample_id) %>%
  mutate_at(vars(Abundance), ~ . / sum(., na.rm = TRUE) ) %>%
  ungroup()%>%
  group_by(sample_name) %>%
  mutate(n = n_distinct(sample_id)) %>%
  ungroup()%>%
  group_by(sample_name, Species) %>%
  mutate(diff = n_distinct(sample_id)) %>%
  ungroup() %>%
  mutate(perc = diff / n)

test %>% 
  ggplot(aes(x = Abundance, y=perc)) +
  geom_point(position=position_jitter(width=0.01, height=0.01), alpha=0.1) + 
  scale_x_log10(labels=scales::percent)+
  geom_smooth(method="lm") +
  base_theme

broom::tidy(lm(formula = perc ~ Abundance, data=test))

# Get mean pairwise distance within all replicates in a sample, or number of taxa detected?
rep_distance <- ps1 %>%
  subset_samples(fcid=="HLVKYDMXX") %>%
  speedyseq::tax_glom(taxrank = "Species") %>%
  otu_table() %>%
  as("matrix") %>%
  as_tibble(rownames = "sample_id") %>%
  #filter(!str_detect(sample_id, "BLANK|SynMock|POS")) %>%
  left_join(sample_data(ps1) %>%
              as("data.frame") %>%
              as_tibble()%>%
              dplyr::filter(fcid=="HLVKYDMXX") %>%
              dplyr::select(sample_name, sample_id)  %>%
              distinct()) %>%
  group_by(sample_name) %>%
  add_tally() %>%
  filter(n > 1) %>%
  dplyr::select(-n) %>%
  #filter(str_detect(sample_id, "POS")) %>%
  #group_split()
  group_modify(~ {
      .x %>% 
        column_to_rownames("sample_id")%>%
        dplyr::select(-any_of(c("sample_id", "sample_name", "extract_id", "type", "fcid"))) %>%
        dplyr::select(where(~ !(sum(.)==0))) %>%
        as.matrix() %>%
        vegdist(method="jac", binary = TRUE) %>%
        as.matrix() %>%
        as_tibble(rownames="sample_1") %>%
        pivot_longer(-sample_1,
                     names_to = "sample_2",
                     values_to = "dist")%>%
        dplyr::filter(dist > 0)
    })

gg.repjac <- rep_distance %>%
  mutate(sample_name = sample_name %>%
           str_remove("HLVKYDMXX_") %>%
           str_replace("^D2","D02") %>%
           str_replace("^D5","D05")) %>%
  right_join(rep_data %>% dplyr::select(sample_name, type) %>% distinct()) %>%
  mutate(type = type %>%
           factor(levels=c("POS", "Adult Mock", "Larval Mock","FF","SPD", "DC", "ACV"))) %>%
  #filter(!is.na(type)) %>%
  ggplot(aes(x = sample_name, y = 1-dist, colour=1-dist))+
  geom_boxplot(outlier.color = NA)  +
  geom_point(alpha=0.5, position= position_jitter(width=0.2))+
  scale_colour_viridis_c( )+
  coord_cartesian(ylim = c(0,1))+
  scale_y_continuous(labels = scales::percent)+
  base_theme+
  theme(strip.text.x = element_blank())+
  labs(x = "Sample",
       y = "Pairwise Jaccard similarity")+
  facet_grid(.~type, scales="free", space="free", drop=TRUE)

# pairwise distance as function of pairwise difference in sequencing depth
gg.jacpw <- rep_distance %>%
  mutate(sample_name = sample_name %>%
           str_remove("HLVKYDMXX_") %>%
           str_replace("^D2","D02") %>%
           str_replace("^D5","D05")) %>%
  left_join(rep_data %>%
               dplyr::select(sample_1 = sample_id, abundance_1 = Abundance) %>%
               distinct()) %>%
  left_join(rep_data %>%
               dplyr::select(sample_2 = sample_id, abundance_2 = Abundance) %>%
               distinct()) %>%
  mutate(diff_abund = abs(abundance_2 -abundance_1)) %>%
  ggplot(aes(x = diff_abund, y = 1-dist, colour=1-dist)) +
  geom_point(alpha=0.2) +
  geom_smooth(method="lm") +
  stat_cor(label.y = 0.95, label.x = 10,size=3,
           aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))) +
  scale_y_continuous(labels = scales::percent, position="right")+
  scale_x_continuous(labels = scales::label_number_si())+
  scale_colour_viridis_c( )+
  base_theme +
  labs(x = "Pairwise difference in seq depth",
       y = "Pairwise Jaccard Similarity")+
  coord_cartesian(ylim = c(0,1))
  

gg.jacpw

# Anova of difference
rep_dist_types <- rep_distance %>%
  left_join(sample_data(ps1) %>%
              as("matrix") %>%
              as.data.frame() %>%
              dplyr::select(sample_name, type) %>%
              distinct()) %>%
  dplyr::filter(!(sample_1 == sample_2)) %>%
  group_by(type) %>%
  add_tally() %>%
  #filter(type %in% c("DC", "FF", "SPD"))
  filter(!type %in% c("ACV", "POS"))

rep_dist_types %>%
  ggplot(aes(x = type, y=dist)) +
  geom_boxplot() +
  geom_point(alpha=0.1)

report::report(aov(dist ~type, data=rep_dist_types))
broom::tidy(TukeyHSD(aov(dist ~type, data=rep_dist_types))) %>%
  mutate(signif = case_when(
    adj.p.value < 0.05 ~ TRUE,
    TRUE ~ FALSE
  )) %>%
  tidyr::separate(contrast, into=c("contrast_1", "contrast_2"), sep="-") %>%
  View()


# Mean pairwise distance between pcr replicates within extraction
mpd_pcr <- ps1 %>%
  subset_samples(fcid=="HLVKYDMXX") %>%
  speedyseq::tax_glom(taxrank = "Species") %>%
  otu_table() %>%
  as("matrix") %>%
  as_tibble(rownames = "sample_id") %>%
  filter(!str_detect(sample_id, "BLANK|SynMock|POS")) %>%
  left_join(sample_data(ps1) %>%
              as("data.frame") %>%
              as_tibble()%>%
              dplyr::filter(fcid=="HLVKYDMXX") %>%
              dplyr::select(sample_id, sample_name, extract_id)  %>%
              distinct()) %>%
  group_by(sample_name, extract_id) %>%
  add_tally()  %>%
  filter(n > 1) %>%
  dplyr::select(-n) %>%
  group_modify(~ {
      .x %>% 
        dplyr::select(-any_of(c("sample_id", "sample_name", "extract_id", "fcid"))) %>%
        dplyr::select(where(~ !(sum(.)==0))) %>%
        as.matrix() %>%
        vegdist(method="jac", binary = TRUE) %>%
        as.matrix() %>%
        as_tibble()%>%
        pivot_longer(everything(),
                     names_to = "sample",
                     values_to = "dist")%>%
        dplyr::filter(dist > 0) %>%
        summarise(dist = mean(dist), n = n_distinct(sample)) 
    })

# Mean pairwise distance of extraction reps within samples
mpd_extraction <- ps1 %>%
  subset_samples(fcid=="HLVKYDMXX") %>%
  merge_samples(group = "extract_id", fun="sum") %>%
  speedyseq::tax_glom(taxrank = "Species") %>%
  otu_table() %>%
  as("matrix") %>%
  as_tibble(rownames = "extract_id") %>%
  filter(!str_detect(extract_id, "BLANK|SynMock|POS")) %>%
  left_join(sample_data(ps1) %>%
              as("data.frame") %>%
              as_tibble()%>%
              dplyr::filter(fcid=="HLVKYDMXX") %>%
              dplyr::select(sample_name, extract_id)  %>%
              distinct()) %>%
  group_by(sample_name) %>%
  add_tally() %>%
  filter(n > 1) %>%
  dplyr::select(-n) %>%
  group_modify(~ {
      .x %>% 
        dplyr::select(-any_of(c("sample_id", "sample_name", "extract_id", "type", "fcid"))) %>%
        dplyr::select(where(~ !(sum(.)==0))) %>%
        as.matrix() %>%
        vegdist(method="jac", binary = TRUE) %>%
        as.matrix() %>%
        as_tibble()%>%
        pivot_longer(everything(),
                     names_to = "sample",
                     values_to = "dist")%>%
        dplyr::filter(dist > 0) %>%
        summarise(dist = mean(dist), n = n_distinct(sample)) 
    })


# Mean pairwise distance within collection methods
mpd_traps <- ps1 %>%
  subset_samples(fcid=="HLVKYDMXX") %>%
  merge_samples(group = "sample_name", fun="sum") %>%
  speedyseq::tax_glom(taxrank = "Species") %>%
  otu_table() %>%
  as("matrix") %>%  
  as_tibble(rownames = "sample_name") %>%
  filter(!str_detect(sample_name, "BLANK|SynMock|POS")) %>%
  left_join(sample_data(ps1) %>%
              as("data.frame") %>%
              as_tibble()%>%
              dplyr::filter(fcid=="HLVKYDMXX") %>%
              dplyr::select(sample_name, type)  %>%
              distinct()) %>%
  group_by(type) %>%
  add_tally() %>%
  filter(n > 1) %>%
  dplyr::select(-n) %>%
  group_modify(~ {
      .x %>% 
        dplyr::select(-any_of(c("sample_id", "sample_name", "extract_id", "type", "fcid"))) %>%
        dplyr::select(where(~ !(sum(.)==0))) %>%
        as.matrix() %>%
        vegdist(method="jac", binary = TRUE) %>%
        as.matrix() %>%
        as_tibble()%>%
        pivot_longer(everything(),
                     names_to = "sample",
                     values_to = "dist")%>%
        dplyr::filter(dist > 0)  %>%
        summarise(dist = mean(dist), n = n_distinct(sample)) 
    }) %>%
  mutate(enviro = type)

# Mean pairwise distance within orchard
#mpd_orchard <- ps1 %>%
#  subset_samples(fcid=="HLVKYDMXX") %>%
#  merge_samples(group = "sample_name", fun="sum") %>%
#  speedyseq::tax_glom(taxrank = "Species") %>%
#  otu_table() %>%
#  as("matrix") %>%  
#  as_tibble(rownames = "sample_name") %>%
#  filter(!str_detect(sample_name, "BLANK|SynMock|POS")) %>%
#  left_join(sample_data(ps1) %>%
#              as("data.frame") %>%
#              as_tibble()%>%
#              dplyr::filter(fcid=="HLVKYDMXX") %>%
#              mutate(enviro = case_when(
#                str_detect(sample_name,"_T") ~ "Cherries",
#                str_detect(sample_name, "_M") ~ "Stonefruit",
#                str_detect(sample_name, "_D") ~ "Mock")) %>%
#              dplyr::select(sample_name, enviro, type)  %>%
#              distinct()) %>%
#  group_by(enviro) %>%
#  add_tally() %>%
#  filter(n > 1) %>%
#  dplyr::select(-n) %>%
#  group_modify(~ {
#      .x %>% 
#        dplyr::select(-any_of(c("sample_id", "sample_name", 
#                                "extract_id", "type", "fcid", "enviro"))) %>%
#      dplyr::select(where(~ !(sum(.)==0))) %>%
#        as.matrix() %>%
#        vegdist(method="jac", binary = TRUE) %>%
#        as.matrix() %>%
#        as_tibble()%>%
#        pivot_longer(everything(),
#                     names_to = "sample",
#                     values_to = "dist")%>%
#        dplyr::filter(dist > 0)  %>%
#        summarise(dist = mean(dist), n = n_distinct(sample)) 
#    })
#
# Plot together:
gg.mpd <- do.call("list", mget(grep("mpd_",names(.GlobalEnv),value=TRUE))) %>%
  bind_rows(.id="type") %>%
  ungroup %>%
  dplyr::select(sample_name, type, dist, enviro) %>%
  mutate(type = type %>% 
           str_remove("^.+_") %>%
           str_replace("orchard", "Location") %>%
           str_replace("traps", "Biological reps") %>%
           str_replace("extraction", "Extraction reps") %>%
           str_replace("pcr", "PCR reps") %>%
           factor(levels = c("PCR reps", "Extraction reps", "Biological reps", "Location"))
         ) %>%
  mutate(Community = case_when(
    str_detect(sample_name, "_D[0-9]|_DM|_DL") ~ "Mock",
    enviro %in% c("Mock", "DrosLarv", "DrosMock") ~ "Mock",
    TRUE ~ "Trap"
  )) %>%
  ggplot(aes(x = type, y = 1-dist, fill=Community)) + 
  geom_point(position=position_jitter(width = 0.1),size=2, shape=21, alpha=0.8, colour="black")+
  geom_boxplot(alpha=0.3, colour="black", fill=NA, outlier.colour = NA, show.legend = FALSE) +
  base_theme + 
  theme(legend.position = "top")+
  coord_cartesian(ylim=c(0,1))+
  scale_y_continuous(labels = scales::percent, position = "right")+
  scale_x_discrete(position = "top")+
  theme(axis.text.x = element_text(angle = 45, hjust = 0, vjust=0))+
  #coord_flip(ylim=c(0,1))+
  scale_fill_viridis_d()+
  scale_colour_viridis_d()+
  #scale_colour_brewer(palette= "Set1") +
  labs(x = NULL,
       y = "Mean Pairwise Jaccard similarity")

gg.mpd 

# Replicate figure
gg.repfiga <- gg.repmap / gg.repjac + plot_layout(heights = c(2,1))
gg.repfigb <- gg.mpd / gg.jacpw  + plot_layout(heights = c(2,1))
gg.rep_multifig <-  gg.repfiga - gg.repfigb + plot_layout(widths = c(5,1)) + plot_annotation(tag_levels = "A") 
gg.rep_multifig

pdf(file="fig/Fig2_replicates.pdf", width = 11, height = 8 , paper="a4r")
  plot(gg.rep_multifig)
try(dev.off(), silent=TRUE)
```


## Train detection model

We will filter index switching using a logistic regression model trained on the mocks

```{r index switch removal}
# Subset to mocks
ps_model <- ps1

tax_table(ps_model)[,8] <- tax_table(ps_model)[,8] %>% str_replace(" ", "_")
# Check Drosophila_suzukii in sample D500M1 - these are definitely misplaced and ruinign the modelling

#Rename taxa to match expected
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Drosophila_albomicans")] <-
"Drosophila_immigrans"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Drosophila_nasuta")] <-
"Drosophila_immigrans"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Drosophila_hypocausta")] <-
"Drosophila_immigrans"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Drosophila_pulaua")] <-
"Drosophila_immigrans"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Drosophila_kohkoa")] <-
"Drosophila_immigrans"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Drosophila_rubida")] <-
"Drosophila_immigrans"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Drosophila_sulfurigaster")] <-
"Drosophila_immigrans"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Drosophila_mauritiana/simulans")] <-
"Drosophila_simulans"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Carpophilus_dimidiatus/nr.dimidiatus")] <-
"Carpophilus_nr.dimidiatus"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Brachypeplus_Sp1")] <- "Brachypeplus_Sp"
tax_table(ps_model)[,8][which(tax_table(ps_model)[,8]=="Brachypeplus_Sp2")] <- "Brachypeplus_Sp"

ps_model <- ps_model %>%
  speedyseq::tax_glom(taxrank = "Species") %>%
  subset_samples(fcid %in% c("CB3DR", "HLVKYDMXX")) %>%
  filter_taxa( function(x) mean(x) > 0, TRUE) 

sample_data(ps_model)$sample_name <- sample_data(ps_model)$sample_name  %>%
  str_replace("DM1$", "D100M1") %>%
  str_replace("DM2$", "D100M2") %>%
  str_replace("DM3$", "D100M3") %>%
  str_replace("DM4$", "D100M4") %>%
  str_replace("DM5$", "D100M5")

sample_data(ps_model)$sample_id <- sample_data(ps_model)$sample_id  %>%
  str_replace("DM1$", "D100M1") %>%
  str_replace("DM2$", "D100M2") %>%
  str_replace("DM3$", "D100M3") %>%
  str_replace("DM4$", "D100M4") %>%
  str_replace("DM5$", "D100M5")

exp <- read_csv("sample_data/expected_quant_merged.csv") %>%
  dplyr::rename(sample_name = Sample) %>%
  pivot_longer(-sample_name,
               names_to= "taxon",
               values_to= "expected") %>%
  mutate(taxon = str_replace(taxon, pattern=" ",replacement="_"),
         sample_name = str_remove(sample_name, "-exp*.$")) %>%
  dplyr::filter(!is.na(sample_name),
  !str_detect(sample_name, "CM[0-9]|CT[0-9]|CML[0-9]|Syn"),
  expected > 0) %>%
  distinct() %>%
  mutate(expected_RA = expected) %>%
  group_by(sample_name) %>%
  mutate_at(vars(expected_RA), ~ . / sum(., na.rm = TRUE) ) %>%
  ungroup()

# Calculate alpha div
#Set number of randomisations for calculating significance
ps.alpha <- ps_model %>%
    merge_samples(group = "sample_name", fun="sum")

richness <- phyloseq::estimate_richness(ps.alpha, measures=c("Chao1", "Shannon", "Simpson")) %>% #
  rownames_to_column("sample") %>%
  mutate(sample = str_replace(sample, "\\.", "-"))

# Calculate Faith's PD-index & Species richness - with Standard errors
sespd <- picante::ses.pd(as(phyloseq::otu_table(ps.alpha), "matrix"),  phyloseq::phy_tree(ps.alpha), null.model = "taxa.labels", include.root = F, runs = 1)

# Join together
div_table <- sespd %>%
  rownames_to_column("sample") %>%
  dplyr::select(sample, ntaxa, pd.obs) %>%
  dplyr::rename(pd = pd.obs, alpha = ntaxa) %>%
  left_join(richness, by="sample") %>%
  dplyr::rename(sample_id = sample)


# Merge replicates and get observed
sam <- speedyseq::psmelt(ps_model) %>%
  janitor::clean_names() %>%
  mutate(taxon = species) %>%
  filter(fcid %in% c("CB3DR", "HLVKYDMXX"))  %>%
  group_by(sample_id,fcid, pcr_primers)  %>%
  dplyr::mutate(abundance_RA = abundance, total_seq = sum(abundance)) %>%
  #mutate(abundance_RA = abundance_RA + 0.5) %>% # Add pseudocount
  mutate_at(vars(abundance_RA), ~ . / sum(.) ) %>%
  group_by(sample_id, fcid, pcr_primers)  %>%
  mutate(abundance_clr = abundance_RA) %>%
  mutate_at(vars(abundance_clr ), ~metacal::clr(.) ) %>%
  ungroup() %>%
  dplyr::select(otu, sample_name, extract_id, sample_id, taxon, pcr_primers,fcid, material_type = type, abundance, abundance_RA, abundance_clr,total_seq) %>%
  distinct() %>%
  group_by(sample_name, otu, fcid) %>%
  mutate(n_extract = case_when( # Need this to only count reps they were detected in!
    abundance > 0 ~ extract_id,
    TRUE ~ as.character(NA)
  ),
  n_rep = case_when(
    abundance > 0 ~ sample_id,
    TRUE ~ as.character(NA)
  )) %>%
  mutate(n_extract = n_distinct(n_extract, na.rm = TRUE), n_rep = n_distinct(n_rep, na.rm = TRUE))%>%
  mutate(taxon = taxon %>% str_replace(" ", "_")) %>%
  mutate(sample_id = sample_name,
         sample_name = sample_name %>%      
         str_remove_all("BF1-BR1-|SauronS878-HexCOIR4-|fwhF2-HexCOIR4-|fwhF2-fwhR2n-") %>%
         str_remove_all("HLVKYDMXX_|CK3HD_|CB3DR_|CJKFJ_")) %>%
  group_by(otu, sample_name, sample_id, taxon, pcr_primers, fcid, material_type, n_rep, n_extract) %>%
  summarise(abundance = sum(abundance), abundance_RA = mean(abundance_RA), abundance_clr = mean(abundance_clr), total_seq = sum(total_seq)) %>%   # I should be taking the mean of the relative abundance
  ungroup() %>%
  left_join(div_table)

#Create a mocks table to train the model on
model_df <- sam %>%
  mutate(type = case_when( 
         (sample_name %in% exp$sample_name) &
         (material_type == "DrosMock") & !str_detect(taxon, "__") ~ "train",
         TRUE ~ "test")) %>%
  left_join(exp, by = c("sample_name","taxon"))  %>%
  left_join(exp %>%
              group_by(sample_name) %>%
              mutate(total_abund = sum(expected))%>%
              ungroup() %>%
              dplyr::select(sample_name, total_abund) %>%
              distinct(), by="sample_name") %>%
  mutate(outcome = case_when(
    abundance > 0 & is.na(expected) & type== "train" ~ 0, #False positive - only count for mocks
    abundance > 0 & !is.na(expected) ~ 1, # True positive
    abundance == 0 & expected > 0 ~ 1, # False negative
    abundance ==0 & is.na(expected) & type== "train" ~ 0 # True negative - only count for mocks
  )) %>%
  dplyr::select(fcid, sample_id, sample_name, otu, taxon, abundance, abundance_clr, abundance_RA,pcr_primers, outcome, n_extract, n_rep, alpha, pd, Shannon, total_seq, total_abund, expected, expected_RA) %>%
  mutate(outcome_all = outcome) %>%
  mutate(outcome = case_when(
    outcome == 0 & abundance_RA > 0.01 ~ as.numeric(NA), #Deal with obvious misannotated expecteds
    outcome == 1 & abundance == 0 ~ as.numeric(NA), #Deal with total dropouts
    !pcr_primers == "fwhF2-fwhR2n" ~ as.numeric(NA), #Dont use the other primers
    TRUE ~ outcome
  )) %>%
  #filter(!is.na(outcome)) %>%
  mutate(outcome = factor(outcome, levels=c("0", "1")))

# Get just known outcomes
mock_dat <- model_df %>%
  filter(!is.na(outcome)) 

# Create dataset split
set.seed(seed = 42) 

mock_split <- initial_split(mock_dat,strata=outcome, prop=0.8)
mock_train <- training(mock_split)
mock_test <- testing(mock_split)

# Cross validations
mock_cv <- vfold_cv(mock_train, v = 10)

# Create modelling recipe
switch_recipe <- recipe(outcome ~ abundance_RA + fcid + n_rep + n_extract, data = mock_train) %>%
  step_novel(all_nominal(), -all_outcomes()) %>% 
  step_dummy(fcid, one_hot = FALSE) %>% 
  step_zv(all_predictors()) %>%
  step_normalize(n_rep, n_extract, abundance_RA)
  #step_normalize(alpha, pd, n_rep, n_extract, total_abund) #

juice(prep(switch_recipe))

#+ alpha + pd + total_abund

# Define model
glmnet_spec <- logistic_reg() %>%  #penalty = tune(), mixture = tune()
  set_mode("classification") %>% 
  set_engine("glm") 

# Create workflow
glmnet_wf <- workflow() %>%
  add_recipe(switch_recipe) %>%
  add_model(glmnet_spec)

#glmnet_grid <- tidyr::crossing(penalty = 10^seq(-6, -1, length.out = 20), mixture = c(0.05, 
#    0.2, 0.4, 0.6, 0.8, 1)) 

#glmnet_tune <- 
#  tune_grid(glmnet_wf, resamples = mock_cv, grid = glmnet_grid) 

#autoplot(glmnet_tune)

#glmnet_wf <- glmnet_wf %>%
#  finalize_workflow(glmnet_tune %>% select_best("roc_auc" ))

# Fit to resamples
#glmnet_wf %>%
#  fit_resamples(mock_cv) %>%
#  unnest(.metrics) %>%
#  filter(.metric == "roc_auc") %>%
# summarise(roc_auc = mean(.estimate))

  
# See how it went on the training dataset
predictions_glm <- mock_train %>%
  nest(everything()) %>%
  dplyr::rename(train = data) %>%
  bind_cols(mock_test %>%
              nest(everything()) %>%
              dplyr::rename(test = data)) %>%
  mutate(model_obj = purrr::map(train, ~fit(glmnet_wf, .x)),
         pred_train = purrr::map2(model_obj, train, ~predict(.x, .y, type = "prob")),
         pred_test = purrr::map2(model_obj, test, ~predict(.x, .y, type = "prob")),
         #pred_curve = purrr::map2(model_obj, test, function(x, y){
         #     newdat <- data.frame(abundance_clr=seq(min(y$abundance_clr),
         #                                            max(y$abundance_clr),len=1000),
         #                          abundance=as.integer(seq(min(y$abundance),
         #                                            max(y$abundance),len=1000)),
         #                          abundance_RA=seq(min(y$abundance_RA),
         #                                           max(y$abundance_RA),len=1000),
         #                          n_rep=1,
         #                          n_extract=1,
         #                          alpha=1,
         #                          pd=1,
         #                          total_abund=1,
         #                          fcid="HLVKYDMXX")
         #     newdat <- newdat %>%
         #       bind_cols(predict(x, new_data=newdat, type="prob")) %>%
         #       mutate(prob = round(.pred_1,1))
         #     plot_dat <- y %>%
         #      mutate(outcome_1 = case_when(
         #         outcome == 0 ~ 0,
         #         outcome == 1 ~ 1)) 
         #     
         #     annot <- newdat %>% 
         #                    filter(prob==0.5) %>%
         #                    summarise(abundance_clr = mean(abundance_clr),
         #                              abundance_RA = mean(abundance_RA))
         #       
         #     ggplot(plot_dat, aes(x = abundance_RA, y = outcome_1, colour = outcome)) +
         #       geom_point(alpha=0.5,size=1, position=position_jitter(width=0.001, height=0)) + 
         #       geom_line(data = newdat, aes(x = abundance_RA, y = .pred_1),
         #                 inherit.aes = FALSE, size=1,  alpha=0.5) +
         #       geom_vline(xintercept = annot$abundance_RA, colour="grey30", alpha=0.5, size=1)+
         #       base_theme +
         #       theme(legend.position = "right")+
         #       #scale_x_log10()+
         #       scale_colour_manual(values = c("0" = "#F8766D", "1" = "#00BFC4" ))+
         #       labs(x = "Abundance (CLR)",
         #            y = "Prediction probability",
         #            colour="Outcome")
         #}),

          vip = purrr::map(model_obj ,~{
            .x %>%
            pull_workflow_fit() %>%
            vip::vi()
         }),
         coef_info = purrr::map(model_obj,~{
           .x %>% 
             pull_workflow_fit() %>%
             broom::tidy()
         })
  )

library(probably)

# Confusion matrix
gg.conf_matrix <- predictions_glm %>%
  unnest(test, pred_test) %>%
  dplyr::select(-where(~is.list(.x))) %>%
  mutate(.pred = factor(make_two_class_pred(.pred_0, levels(outcome), threshold = .5)))%>%
  mutate(.pred = factor(.pred, levels = levels(outcome))) %>%
  conf_mat(outcome, .pred) %>%
  pluck(1) %>%
  as_tibble() %>%
  ggplot(aes(Prediction, Truth, alpha = n)) +
  geom_tile(show.legend = FALSE) +
  geom_text(aes(label = n), colour = "white", alpha = 1, size = 8)

gg.conf_matrix

# Plot regression curve
predictions_glm %>%
  pull(pred_curve)

pdf(file="fig/supplementary/log_curve.pdf", width = 6, height = 4 , paper="a4r")
  plot(predictions_glm$pred_curve[[1]])
try(dev.off(), silent=TRUE)
  
# Calculate performance over number of predictors
threshold_data <- predictions_glm %>%
  unnest(train, pred_train) %>%
  dplyr::select(-where(~is.list(.x))) %>%
  threshold_perf(outcome, .pred_1, thresholds = seq(0, 1, by = 0.0025)) %>%
  filter(!.metric == "distance") %>%
  mutate(.metric = .metric %>% 
           str_replace("sens", "Sensitivity") %>%
           str_replace("spec", "Specificity") %>%
           str_replace("j_index", "J Index"))

max_j_index_threshold <- threshold_data %>%
  filter(.metric == "J Index") %>%
  filter(.estimate == max(.estimate)) %>%
  summarise(upper = max(.threshold), lower = min(.threshold))

gg_thresholds <- threshold_data %>%
  mutate(.metric = factor(.metric, levels = c("Sensitivity","Specificity","J Index" ))) %>%
  ggplot(aes(x = .threshold, y = .estimate, color = .metric)) +
    geom_line(size=1) +
    base_theme +
    scale_color_viridis_d(end = 0.9) +
    scale_alpha_manual(values = c(.4, 1), guide = "none") +
    geom_rect(data = max_j_index_threshold, aes(xmin = lower, xmax=upper,
                 ymin=0, ymax=1), alpha = .3, fill = "grey30", inherit.aes = FALSE) +
    #geom_vline(xintercept = max_j_index_threshold, alpha = .6, color = "grey30")+
    facet_grid(.metric~.) +
    labs(
      x = "Confidence threshold\n(above this value is considered a detection)",
      y = "Metric Estimate",
      title = "Balancing performance by varying the confidence threshold"
    ) 

gg_thresholds

pdf(file="fig/supplementary/logistic_prob_thresholds.pdf", width = 11, height = 8 , paper="a4r")
  plot(gg_thresholds)
try(dev.off(), silent=TRUE)

# Get coefficients
predictions_glm  %>%
  dplyr::select(coef_info) %>%
  unnest() %>%
  mutate(signif = case_when(
    p.value < 0.001 ~ TRUE,
    p.value > 0.001 ~ FALSE
  )) %>%
 # mutate(estimate = exp(estimate)) %>%
  ggplot(aes(x = estimate, y = term, colour=signif)) +
  geom_pointrange(aes(x = estimate, xmax=estimate+std.error, xmin=estimate-std.error ), size=1) +
  labs(y = NULL) +
  base_theme + 
  geom_vline(xintercept=0) + 
  theme(legend.position = "right")
  
# Get importance of predictors
predictions_glm  %>%
  dplyr::select(vip) %>%
  unnest() %>%
  group_by(Sign) %>%
  ggplot(aes(x = Importance, y = Variable, fill = Sign)) +
  geom_col() +
  labs(y = NULL)

# Check for disagreements within mock
test <- predictions_glm %>%
  unnest(test, pred_test) %>%
  dplyr::select(-where(~is.list(.x))) %>%
  mutate(.pred = factor(make_two_class_pred(.pred_0, levels(outcome), threshold = .5)))%>%
  #dplyr::select(.pred, abundance_clr,abundance,  taxon, outcome)  %>%
  mutate(diff = !.pred == outcome)

# plot curve
roc_data <- predictions_glm %>%
   unnest(test, pred_test) %>%
  roc_curve(truth = outcome, .pred_0) 
gg.roc_curve <- roc_data %>%  
  ggplot(aes(x = 1 - specificity, y = sensitivity)) +
  geom_path() +
  geom_abline(lty = 3) + 
  coord_equal()

gg.roc_curve

# Calculate metrics
multimetric <- metric_set(accuracy, bal_accuracy, sens, yardstick::spec, precision, recall, ppv, npv)
predictions_glm %>%
  unnest(test, pred_test) %>%
  dplyr::select(-where(~is.list(.x))) %>%
  mutate(.pred = make_two_class_pred(.pred_0, levels(outcome), threshold = .5)) %>%
  multimetric(truth = outcome, estimate = factor(.pred, levels= levels(outcome)))  
```

# merge replicates and remove index switching

```{r merge replicates}
# Merge replicates
ps.merged <- ps_model %>%
    merge_samples(group = "sample_name", fun="sum")

##This loses the sample metadata - Need to add it agian
sample_data(ps.merged) <- sample_data(ps_model) %>%
  as("data.frame")  %>%
  mutate(sample_id = sample_name) %>%
  mutate(sample_name = sample_name %>%
           str_remove_all("BF1-BR1-|SauronS878-HexCOIR4-|fwhF2-HexCOIR4-|fwhF2-fwhR2n-") %>%
           str_remove("HLVKYDMXX_")) %>%
  dplyr::filter(!duplicated(sample_id)) %>%
  magrittr::set_rownames(.$sample_id)

saveRDS(ps.merged, "output/rds/ps_merged.rds")

## Train model again on full mock dataset and predict unknowns
final_logistic_glm <- glmnet_wf  %>%
  fit(mock_dat)

final_predictions_glm <- final_logistic_glm %>%
  predict(new_data = model_df, type="prob") %>%
  bind_cols(model_df) %>%
  mutate(outcome = factor(outcome, levels = c("1", "0"))) %>%
  mutate(.pred = factor(make_two_class_pred(.pred_1, levels(outcome), threshold = .5)))%>%
  mutate(diff = !.pred == outcome_all, diff2=!outcome == outcome_all)


# Get importance of predictors
final_logistic_glm %>%
  pull_workflow_fit() %>% 
  vip::vi() %>%
  unnest() %>%
  group_by(Sign) %>%
  ggplot(aes(x = Importance, y = Variable, fill = Sign)) +
  geom_col() +
  labs(y = NULL)

taxon_roc <- final_predictions_glm %>%
  filter(pcr_primers =="fwhF2-fwhR2n") %>%
  mutate(outcome = outcome_all) %>% # Set back to orginal outcomes
  mutate(outcome = factor(outcome, levels = c("0", "1"))) %>% 
  filter(!is.na(outcome)) %>%
  filter(taxon %in% exp$taxon) %>%
  group_by(taxon) %>%
  group_modify(~{
    # Add 1 fake FP observation per taxon to allow ROC curve
    if(length(unique(.x$outcome)) == 1){
      fake_obs <- .x %>%
        dplyr::slice(1) %>%
        mutate(.pred_0 = 0.9999, .pred_1 = 0.0001, outcome=as.factor("0"))
      .x <- .x %>%
        bind_rows(fake_obs)  
    }
    return(.x)
  })


roc_annot <- taxon_roc %>%
  roc_auc(truth = outcome, .pred_0)

# Could split outcome into real outcome, and training outcome

gg.roc_curve <- taxon_roc %>%  
  roc_curve(truth = outcome, .pred_0) %>%
  left_join(taxon_roc %>%
  roc_auc(truth = outcome, .pred_0)) %>%
   mutate(taxon = taxon %>%
           str_replace("_", " ") ) %>%
  #filter(.threshold < Inf & .threshold > -Inf) %>%
  filter(taxon %in% c("Drosophila suzukii",
                      "Drosophila subpulchrella",
                      "Drosophila biarmipes",
                      "Drosophila immigrans",
                      "Drosophila hydei",
                      "Drosophila melanogaster",
                      "Drosophila simulans",
                      "Scaptodrosophila lattivitata"
                      )) %>%
  mutate(taxon = paste0(taxon, "\n(AUC: ", round(.estimate, 2), ")")) %>%
  ggplot(aes(x = 1 - specificity, y = sensitivity, colour= taxon)) +
  geom_path(size=1, position=position_dodge(width=0.03), alpha=0.8) +
  geom_abline(lty = 3) + 
  facet_wrap(~taxon, ncol = 4) +
  coord_equal() +
  scale_color_brewer(palette="Paired")+
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  base_theme+
  theme(legend.text = element_text(face="italic"),
        legend.position = "none")+
  labs(colour = "Taxon",
       x = "1 - Specificity",
       y = "Sensitivity")

gg.roc_curve

pdf(file="fig/supplementary/roc_curve.pdf", width = 11, height = 8 , paper="a4r")
  plot(gg.roc_curve)
try(dev.off(), silent=TRUE)


final_predictions_glm %>%
    filter(pcr_primers =="fwhF2-fwhR2n") %>%
  mutate(taxon = taxon %>% str_replace("_", " ")) %>%
  filter(taxon %in% c("Drosophila suzukii",
                             "Drosophila subpulchrella",
                             "Drosophila biarmipes"),outcome == 1 
         ) %>%
  dplyr::select(-where(~is.list(.x))) %>%
  mutate(total_seq = log10(total_seq)) %>%
  pivot_longer(cols=c("Shannon", "alpha", "pd", "total_abund", "total_seq", "expected_RA"),
               names_to = "metric",
               values_to = "value") %>%
  ggplot(aes(x = value, y=.pred_1, colour=taxon, group=taxon))+
  geom_point(alpha=0.5) +
  geom_smooth(method="lm")+
  coord_cartesian(ylim=c(0,1))+
  facet_wrap(metric~., scales="free_x", ncol=1) +
  base_theme+
  scale_colour_brewer(palette="Paired")+
  theme(legend.position="bottom")


# Make a probability surface
newdat <- tidyr::crossing(
  abundance_RA= seq(0, 0.001,len=1000),
  #abundance_clr= seq(min(final_predictions_glm$abundance_clr),                                          max(final_predictions_glm$abundance_clr),len=1000),
  n_rep = seq(1, 6,1),
  n_extract = seq(1, 2, 1),
  fcid = unique(final_predictions_glm$fcid),
  pcr_primers = unique(final_predictions_glm$pcr_primers),
  )# %>%
# mutate(abundance_clr = seqateurs::clr(abundance_RA))
# How to get htis into somethign reversable

gg.prob_surface <- bind_cols(newdat, final_logistic_glm %>%
  predict(new_data = newdat, type="prob")) %>%
  mutate(.pred = factor(make_two_class_pred(.pred_1, c("0", "1"), threshold = .5)))%>%
  filter(fcid == "HLVKYDMXX") %>%
  #mutate(abundance_RA = exp(abundance_clr)) %>%
  pivot_longer(starts_with("n_"),
               names_to="rep_type",
               values_to="rep_n") %>%
  mutate(rep_type = rep_type %>% str_replace("n_extract", "Extraction") %>% str_replace("n_rep", "PCR")) %>%
  ggplot(aes(x = abundance_RA, y = rep_n))+
  geom_contour_filled(aes(z = .pred_1, colour=.pred_1), alpha=0.8)+
  scale_colour_viridis_d() +
  #facet_grid(~fcid)+
  new_scale_colour()+
  new_scale_fill() +
  geom_point(data=final_predictions_glm  %>%
  pivot_longer(starts_with("n_"),
               names_to="rep_type",
               values_to="rep_n") %>%
      mutate(rep_type = rep_type %>% str_replace("n_extract", "Extraction") %>% str_replace("n_rep", "PCR")) %>%
               filter(fcid == "HLVKYDMXX", abundance_RA < 0.001, rep_n > 0), aes(colour= .pred, fill=.pred_1),
             position = position_jitter(width=0, height=0.01), alpha=1,shape=21, show.legend=FALSE ) +
  scale_colour_manual(values=c('0'="#d7191c", '1'="#2b83ba"))+
  scale_fill_viridis_c() +
  scale_x_continuous(labels = scales::percent, expand = c(0,0)) +
  #scale_y_discrete(expand = c(0,0)) +
  base_theme +
  facet_grid(rep_type~., scales = "free")+
  coord_cartesian(xlim=c(0,0.001), expand = c(0,0))+
  theme(legend.position = "right") +
  labs(x = "Relative abundance",
       y = "Number of replicates") 


gg.prob_surface

# Calculate metrics
target_det <- final_predictions_glm %>%
    filter(fcid == "HLVKYDMXX") %>%
    filter(pcr_primers =="fwhF2-fwhR2n") %>%
  mutate(taxon = taxon %>%
           str_replace("_", " ")) %>%
  filter(taxon %in% c("Drosophila suzukii",
                             "Drosophila subpulchrella",
                             "Drosophila biarmipes")) 

#Problems ot check
problem <- target_det %>% 
  filter(abundance  >0) %>%
  filter(.pred == 1 & is.na(outcome))


# Number of samples
target_det %>% 
  filter(abundance  >0) %>%
  mutate(success = case_when(
    outcome ==1 & .pred == 1 ~ "TP",
    outcome == 1 & .pred == 0 ~ "FN",
    outcome == 0 & .pred == 1 ~ "FP",
    outcome == 0 & .pred == 0 ~ "TN"
  )) %>%
  group_by(taxon) %>%
  summarise(TP = sum(success=="TP", na.rm = TRUE), FN = sum(success=="FN", na.rm = TRUE), 
            FP= sum(success == "FP", na.rm = TRUE), TN = sum(success == "TN", na.rm = TRUE),
            total_pos = sum(success %in% c("TP", "FN")))

multimetric <- metric_set(accuracy, bal_accuracy, sens, yardstick::spec, precision, recall, ppv, npv)
final_metrics <- target_det %>%
  group_by(taxon) %>%
  multimetric(truth = outcome, estimate = .pred)

final_metrics

# Annotate these stats onto the plots

# Dropouts as function of community size 
gg.sens <- target_det %>% 
  filter(abundance  >0) %>%
  mutate(success = case_when(
    outcome ==1 & .pred == 1 ~ "TP",
    outcome == 1 & .pred == 0 ~ "FN",
    outcome == 0 & .pred == 1 ~ "FP",
    outcome == 0 & .pred == 0 ~ "TN"
  )) %>%
  mutate(community = case_when(
    str_detect(sample_id, "_D[0-9]|_DM|_DL") ~ "Mock",
    TRUE ~ "Trap"
  )) %>% 
  dplyr::filter(success %in% c("TP", "FN")) %>%
    left_join(final_metrics  %>% 
              filter(.metric %in% c("sens", "spec", "ppv", "npv", "bal_accuracy")) %>%
              mutate(.estimate = scales::percent(.estimate, accuracy=0.1)) %>%
              pivot_wider(names_from=.metric,
                          values_from=.estimate)) %>%
  #filter(taxon == "Drosophila suzukii") %>%
  mutate(taxon = taxon %>%
         factor(levels = c("Drosophila suzukii",
                             "Drosophila subpulchrella",
                             "Drosophila biarmipes"))) %>%
  ggplot(aes(x = expected_RA, y=abundance_RA, colour=success, shape=community)) + 
  geom_point(size=2, alpha=1, position=position_jitter(width=.001, height=0.001)) + 
  geom_abline(lty = 2, colour = "gray80", size = 1) +
  #geom_text(aes(x=0.02, y=0.15, label=paste0("Sens:", sens)), check_overlap = TRUE, hjust=0, colour="black")+
  #geom_text(aes(x=0.02, y=0.14, label=paste0("Spec:", spec)), check_overlap = TRUE, hjust=0, colour="black")+
  #geom_text(aes(x=0.02, y=0.13, label=paste0("PPV:", ppv)), check_overlap = TRUE, hjust=0, colour="black")+
  #geom_text(aes(x=0.02, y=0.12, label=paste0("NPV:", npv)), check_overlap = TRUE, hjust=0, colour="black")+
  facet_wrap(taxon~.) +
  base_theme +
  theme(legend.position = "right",
        strip.text.x = element_text(face="italic"))+
  scale_colour_viridis_d()+
  coord_cartesian(clip = "off") +
  scale_x_log10(labels = scales::percent)+
  scale_y_log10(labels = scales::percent)+
  annotation_logticks(sides="lb", outside = TRUE) +
  #  scale_x_continuous(labels = scales::percent)+
  #scale_y_continuous(labels = scales::percent) +
  labs(x = "Expected relative abundance (from specimens)",
       y = "Observed relative abundance (from sequencing)",
       shape = "Community Type",
       colour = "Detection Success")

gg.sens


# Filter predicted switching
keeptab <- final_predictions_glm %>%
  dplyr::select(.pred, sample_id , otu) %>%
  mutate(keep = case_when(
    .pred == 0 ~ 0,
    .pred == 1 ~ 1
  )) %>%
  dplyr::select(-.pred) %>%
  pivot_wider(names_from = otu,
              values_from = keep,
              values_fill = 0) %>%
  dplyr::slice(match(rownames(otu_table(ps.merged)), sample_id)) %>%
  column_to_rownames("sample_id")%>%
  dplyr::select(colnames(otu_table(ps.merged))) %>%
  as.matrix()


#Check for disagreements
colnames(otu_table(ps.merged))[!colnames(otu_table(ps.merged)) %in% colnames(keeptab)]
rownames(otu_table(ps.merged))[!rownames(otu_table(ps.merged)) %in% rownames(keeptab)]

#get current OTU table
otutab <- otu_table(ps.merged) %>%
  as("matrix") 

#Replace taxa predicted as False positives
ps2 <- ps.merged
otu_table(ps2) <- otu_table(otutab * keeptab, taxa_are_rows = FALSE)

# Check staxa that were dropped
dropped <- taxa_sums(ps2) %>%
  as_tibble(rownames = "OTU") %>%
  left_join(taxa_sums(ps1) %>%
  as_tibble(rownames = "OTU") %>%
    dplyr::rename(pre_filt = value)) %>%
  filter(value == 0) 

# Remove zero taxa
ps2 <- filter_taxa(ps2, function(x) mean(x) > 0, TRUE) #Drop missing taxa from table
message(nsamples(ps_model) - nsamples(ps2), " Samples and ", ntaxa(ps_model) - ntaxa(ps2), " taxa under read threshold Dropped")

## Write out final phyloseq
saveRDS(ps2, "output/rds/ps_filtered.rds")

## Write out filtered summaries
dir.create("output/csv/filtered")
speedyseq::psmelt(ps2) %>%
  filter(Abundance > 0) %>%
  write_csv("output/csv/filtered/filtered_data.csv")

#Summary export
seqateurs::summarise_taxa(ps2, "Species", "sample_name") %>%
  filter(!str_detect(sample_name, "NTC")) %>%
  spread(key="sample_name", value="totalRA") %>%
  write.csv(file = "output/csv/filtered/spp_sum.csv")

seqateurs::summarise_taxa(ps2, "Genus", "sample_name") %>%
  spread(key="sample_name", value="totalRA") %>%
  write.csv(file = "output/csv/filtered/gen_sum.csv")

```

# Detection / Switching removal figure

```{r Detection}
pred_boots <- readRDS(file="output/index_switch_bootstraps.rds")

group.colors <- c(TP = "#abdda4", FP = "#d7191c", FN ="#2b83ba", TN ="#cccccc")

gg.switch_resolved <- pred_boots %>%
  #filter(fcid=="HLVKYDMXX") %>%
  group_by(est_type, outcome_post, fcid) %>%
  summarise(count = n(), count_fp = sum(outcome_post == "FP")) %>%
  group_by(est_type, fcid) %>%
  mutate_at(vars(count), ~ . / sum(.) ) %>%
  filter(!(fcid=="CB3DR" & est_type=="pred_pos")) %>%
  mutate(est_type = est_type %>%
           str_replace("pred_logit$", "Logistic Reg") %>%
           str_replace("pred_logit_reps$", "Logistic Reg + Reps") %>%
           str_replace("pred_mock", "Mock Communities") %>%
           str_replace("pred_naive", "0.01% Threshold") %>%
           str_replace("pred_pos", "Positive control") %>%
           str_replace("pred_uncorrected", "Uncorrected") %>%
           str_replace("pred_index", "Unassigned indices")
         ) %>%
  mutate(fcid = case_when(
    fcid == "HLVKYDMXX" ~ "NovaSeq",
    TRUE ~ "MiSeq",
  )) %>%
  mutate(est_type = factor(est_type,
                           levels= c(
    "Logistic Reg + Reps",
    "Logistic Reg",
    "Mock Communities",
    "Positive control",
    "Unassigned indices",
    "0.01% Threshold",
    "Uncorrected"))) %>%
  ggplot(aes(x=est_type, y=count, fill=outcome_post)) + 
  geom_col(position="stack", alpha = 0.8) +
  base_theme+
  coord_flip()+
  facet_wrap(fcid~., ncol=1) +
  scale_y_continuous(labels = scales::percent)+ 
  scale_fill_manual(values=group.colors) + 
  theme(legend.position = "bottom") +
  labs(y = NULL,
       x = NULL,
       fill = "Outcome")

#gg.detection_multi <- gg.switch_resolved - ( gg.roc_curve / gg.prob_surface) + plot_annotation(tag_levels = "A") 

#gg.detection_multi
#
gg.detection_multi <- gg.switch_resolved - ( gg.prob_surface / gg.sens ) + plot_annotation(tag_levels = "A") + plot_layout(widths = c(1,2))

gg.detection_multi


pdf(file="fig/Fig3_detection.pdf", width = 11, height = 8 , paper="a4r")
  plot(gg.detection_multi)
try(dev.off(), silent=TRUE)

```

# Primer comparison

## Overview of run 1

```{r run 1 overview}
# Subset to mocks
ps_run1 <- ps1

tax_table(ps_run1)[,8] <- tax_table(ps_run1)[,8] %>% str_replace(" ", "_")
# Check Drosophila_suzukii in sample D500M1 - these are definitely misplaced and ruinign the modelling

#Rename taxa to match expected
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Drosophila_albomicans")] <-
"Drosophila_immigrans"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Drosophila_nasuta")] <-
"Drosophila_immigrans"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Drosophila_hypocausta")] <-
"Drosophila_immigrans"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Drosophila_pulaua")] <-
"Drosophila_immigrans"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Drosophila_kohkoa")] <-
"Drosophila_immigrans"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Drosophila_rubida")] <-
"Drosophila_immigrans"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Drosophila_sulfurigaster")] <-
"Drosophila_immigrans"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Drosophila_mauritiana/simulans")] <-
"Drosophila_simulans"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Carpophilus_dimidiatus/nr.dimidiatus")] <-
"Carpophilus_nr.dimidiatus"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Brachypeplus_Sp1")] <- "Brachypeplus_Sp"
tax_table(ps_run1)[,8][which(tax_table(ps_run1)[,8]=="Brachypeplus_Sp2")] <- "Brachypeplus_Sp"

ps_run1 <- ps_run1 %>%
  speedyseq::tax_glom(taxrank = "Species") %>%
  subset_samples(fcid %in% c("CB3DR")) %>%
  subset_samples(!str_detect(sample_names(ps_run1),"blank")) %>%
  filter_taxa( function(x) mean(x) > 0, TRUE) 

ps_run1 %>% 
  speedyseq::psmelt() %>%
  group_by(sample_id) %>%
  mutate_at(vars(Abundance), ~ . / sum(.) ) %>% #Convert to proportions
  mutate(plotlabel = case_when(
    Abundance >= 0.01  ~ Species, # Change this to whatever taxrank we want
    Abundance < 0.01 ~ as.character(NA)
    )) %>%
  ggplot(aes(x=sample_name, y=Abundance, fill=plotlabel)) +
  geom_col(position="stack") + 
  facet_grid(pcr_primers~type, scales="free") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip()+
  base_theme+
  theme(legend.position = "bottom") +
  labs(x = "Sample Name",
       y= "Relative abundance",
       fill="Species",
       title = "Run 1 - Primer testing")

# Reads per sample
ps_run1 %>% 
  speedyseq::psmelt() %>%
  group_by(sample_id, sample_name, pcr_primers) %>%
  summarise(Abundance = sum(Abundance)) %>%
  ggplot(aes(x = sample_name, y = Abundance))+
  geom_col() +
  geom_text(aes(label=Abundance),angle=90,hjust=1,vjust=0.5, colour="white")+
  facet_grid(~pcr_primers,scales="free_x", drop=TRUE) + 
  base_theme

ps_run1 %>% 
  speedyseq::psmelt() %>%
  group_by(sample_id, sample_name, pcr_primers) %>%
  summarise(Abundance = sum(Abundance)) %>%
  ungroup() %>%
  summarise(total = sum(Abundance), mean=mean(Abundance), sd = sd(Abundance), upper = range(Abundance)[2], lower=range(Abundance)[1])

# Taxa per primer
ps_run1 %>% 
  speedyseq::psmelt() %>%
  filter(Abundance > 0, !is.na(Abundance)) %>%
  mutate(type = case_when(
    str_detect(sample_name,"D100M") ~ "MOCK",
    TRUE ~ "TRAP"
  ))%>%
  group_by(type, pcr_primers) %>%
  summarise(unique = n_distinct(Species)) 

# Heatmap separate for primers
heatmap_dat <-  ps_run1 %>%
  speedyseq::psmelt() %>%
  dplyr::select(sample_id, OTU, sample_name, Abundance, pcr_primers, Species, type) %>%
  filter(!str_detect(Species, "__")) %>%
  mutate(sample_name = sample_name %>% 
           str_remove("CB3DR_") %>%
          str_remove_all("BF1-BR1-|SauronS878-HexCOIR4-|fwhF2-HexCOIR4-|fwhF2-fwhR2n-"),
         Species = str_replace(Species, "_", " "),
         type = case_when(
           str_detect(sample_name, "D100") ~ "Mock",
           TRUE ~ "Trap"
         )) %>%
  group_by(sample_id, pcr_primers) %>%
  mutate_at(vars(Abundance), ~ . / sum(.) ) %>%
  ungroup() %>%
  filter(Abundance > 0) %>% 
  mutate(Abundance = case_when(
    Abundance <0.00011 ~ as.numeric(NA),
    Abundance > 0.00011 ~ Abundance
  )) %>%
  mutate(Abundance = na_if(Abundance, 0))  %>%
  left_join(read_csv("sample_data/expected_quant_merged.csv") %>%
  dplyr::rename(sample_name = Sample) %>%
  pivot_longer(-sample_name,
               names_to= "Species",
               values_to= "expected") %>%
    mutate(Species = Species %>% str_replace("_", " ")), by = c("sample_name","Species")) %>%
  mutate(expected = na_if(expected, 0))  %>%
  mutate(outcome = case_when(
    type == "Mock" & Abundance > 0 & is.na(expected) ~ "FP",
    type == "Mock" & is.na(Abundance) & expected > 0 ~ "FN"
  )) %>%
  filter(!(is.na(Abundance) & is.na(outcome)))

#Taxa that were different across primers
heatmap_dat %>%
  filter(Abundance > 0) %>% # This is ruin
  group_by(Species) %>%
  mutate(diff = n_distinct(pcr_primers)) %>%
  ungroup() %>%
  filter(diff < 4) %>%
  dplyr::select(sample_name, pcr_primers, Species, diff) %>%
  distinct()

# False positives per primer
heatmap_dat %>%
  filter(!is.na(outcome)) %>%
  group_by(outcome, pcr_primers) %>%
  summarise(unique = n_distinct(Species)) 


# Plot tree
keeptips <- heatmap_dat %>% 
  filter(Abundance > 0) %>%
  dplyr::select(OTU, Species) %>%
  distinct()

tree <- phy_tree(ps_run1)
tree <- drop.tip(tree, tree$tip.label[!tree$tip.label %in% keeptips$OTU])

tree$tip.label <- tree$tip.label %>%
  tibble::enframe(name=NULL, value="OTU") %>%
  left_join(keeptips) %>%
  pull(Species)

mock_tree <- ggtree(tree, ladderize = TRUE)
gg.run1_heatmap <- heatmap_dat %>%
  left_join(mock_tree$data %>% dplyr::rename(Species = label)) %>%
  mutate(Species = factor(Species),
         sample_name = factor(sample_name, levels= c("D100M1", "D100M2", "D100M3", "D100M4", "D100M5", "DM0-FF", "DM0Sach","DM6-SPD", "DM10-FF", "DM10-SPD"))) %>%
    ggplot(aes(x=sample_name, y=fct_reorder(Species, y), fill=Abundance)) +
    geom_tile() +
  scale_fill_viridis_c(labels = scales::percent, na.value = NA, alpha=0.9) +
  new_scale_fill() +
  geom_tile(aes(fill = outcome))+
  scale_fill_manual(values=c("FP" = "#e41a1c", "FN"= "grey60")) +
  base_theme+
  theme(legend.position = "right",
        axis.text.y = element_text(face="italic"),
        axis.title.y = element_blank())+
    labs(x="Sample",
         y="Taxon") +
  facet_grid(~pcr_primers, drop=TRUE)

mock_tree + gg.run1_heatmap + plot_layout(widths = c(1,4))
```

## Bias

```{r Drosophila bias}
ps_bias <- ps_run1

exp <- read_csv("sample_data/expected_quant_merged.csv") %>%
  dplyr::rename(sample_name = Sample) %>%
  pivot_longer(-sample_name,
               names_to= "taxon",
               values_to= "expected") %>%
  mutate(taxon = str_replace(taxon, pattern=" ",replacement="_"),
         sample_name = str_remove(sample_name, "-exp*.$")) %>%
  dplyr::filter(!is.na(sample_name),
  !str_detect(sample_name, "CM[0-9]|CT[0-9]|CML[0-9]|Syn"),
  expected > 0) %>%
  distinct()

#plot expected
exp %>% 
  dplyr::filter(str_detect(sample_name, "^D")) %>%
  group_by(sample_name) %>%
  mutate_at(vars(expected), ~ . / sum(.) ) %>% #Convert to proportions
  ggplot(aes(x=sample_name, y=expected, fill=taxon)) +
  geom_col(position="stack") + 
  scale_fill_brewer(palette="Spectral") +
  scale_y_continuous(labels=scales::percent) +
  base_theme+
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle=45, hjust=1)) +
  labs(x = "Sample Name",
       y= "Relative abundance",
       title="Expected mock communities",
       fill="Species")

#Get observed
sam <- speedyseq::psmelt(ps_bias) %>%
  janitor::clean_names() %>%
  mutate(taxon = species) %>%
  filter(!str_detect(genus, "__")) %>%#Remove unclassified
  dplyr::select(sample_name, taxon, abundance, pcr_primers, fcid, material_type = type) %>%
  mutate(sample_name = sample_name %>%
           str_remove_all("BF1-BR1-|SauronS878-HexCOIR4-|fwhF2-HexCOIR4-|fwhF2-fwhR2n-") %>%
           str_remove("HLVKYDMXX_"),
         sample_id = paste0(fcid, "_", sample_name),
         sample_name = sample_name %>%
           str_remove_all("HLVKYDMXX_|CK3HD_|CB3DR_|CJKFJ_")) 

#Join tables 
joint <- sam %>%
  filter(taxon %in% exp$taxon,
         sample_name %in% exp$sample_name) %>%
  left_join(exp, by = c("sample_name","taxon")) %>%
  dplyr::rename(observed = abundance) %>%
  filter(observed > 0) %>%
  mutate(expected = replace_na(expected, 0),
         observed0 = (observed + 0.5) * (expected > 0),
         error = observed0 / expected) %>%
  distinct() %>%
  group_by(sample_id, pcr_primers) %>%
  mutate_at(vars(observed, expected), ~ . / sum(.) ) %>% #Convert to proportions
  filter(observed > 0.00011) %>% #Remove under threshold
  group_by(sample_id) %>%
  group_modify(~{
    clr_denom <- .x %>%
      pull(error) %>%
      gm_mean(na.rm = TRUE)
    .x %>%
      mutate(error_clr = log(error / clr_denom))
  })


# Visualise the error in all pairwise ratios
gg.ratio <- joint %>%
  dplyr::filter(expected > 0 ) %>%
  dplyr::mutate(Taxon = taxon %>%
                 str_replace("^.+_", paste0(str_extract(taxon, "."), "_"))) %>%
    compute_ratios(group_vars = c("sample_id", "material_type", "pcr_primers")) %>%
  mutate(Pair = paste(Taxon.x, Taxon.y, sep = ":")) %>% 
  ggplot(aes(Pair, expected, colour=sample_id)) +
  geom_hline(yintercept = 1, alpha=0.8) +
  geom_jitter(alpha=0.7) +
  scale_y_log10() +
  base_theme+
  facet_grid(pcr_primers~.)+
    theme(legend.position = "none",
          axis.text.x = element_text(angle=45, hjust=1))+
  labs(y= "Error in taxon ratios (log10)") 

gg.ratio

# Estimate bias on geometrically centred ratios
bias <- joint %>%
  filter(material_type=="DrosMock") %>%
  filter(expected > 0, Abundance > 0) %>%
  group_by(pcr_primers, material_type)  %>%
    nest() %>%
    mutate(fit = purrr::map(data, ~lm(error_clr ~ 0 + taxon , data = .)), 
           tidied =  purrr::map(fit, broom::tidy),
           aug =  purrr::map(fit, broom::augment)
    ) %>%
  dplyr::select(-fit) %>%
  unnest(tidied) %>%
  mutate(taxon = str_remove(term, "taxon"),
         estimate = exp(estimate)) %>%
   dplyr::select(pcr_primers, material_type, taxon, estimate)


# Bootstrap estimation
set.seed(606)
boot_models <- joint %>%
  filter(material_type=="DrosMock") %>%
  filter(expected > 0) %>%
  group_by(pcr_primers) %>%
  group_modify(~{
    bootstraps(.x, times=1000, apparant=TRUE)  %>%
    mutate(fit =  purrr::map(splits, ~lm(error_clr ~ 0 + taxon , data = .)), 
           coef =  purrr::map(fit, function(x){
             broom::tidy(x) %>% 
               mutate(estimate = exp(estimate))}))%>%
    int_pctl(coef)
    }) %>%
  mutate(taxon = str_remove(term, "taxon")) %>%
  dplyr::select(pcr_primers, taxon, lower = .lower, estimate = .estimate, upper = .upper)

  
# See how well bias esitmate fits data
preds <- joint %>%
  left_join(boot_models) %>%
  dplyr::mutate(predicted = expected * estimate) %>%
  group_by(sample_id, pcr_primers) %>%
  mutate_at(vars(predicted), ~ . / sum(., na.rm=TRUE) ) %>%
  filter(expected > 0) %>%
  filter(observed > 0)

# Get RMSE
errors <- preds %>%
  group_by(pcr_primers) %>%
  rmse(truth = observed, estimate = predicted) %>%
  dplyr::select(pcr_primers, rmse = .estimate)

gg.bias_fits <- preds %>%
  mutate(taxon = str_replace(taxon, "_", " ")) %>%
  left_join(errors) %>%
  mutate(rmse = paste0("RMSE = ", round(rmse, 2))) %>%
  ggplot(aes(x=logit(predicted), y=logit(observed), color = taxon))+
  geom_abline(intercept = 0, slope = 1, color = "grey") +
    geom_jitter(width = 0.1, height = 0, alpha=0.7, size=2) +
  geom_text(aes(x=-5, y=-1, label=rmse), check_overlap = TRUE, inherit.aes = FALSE)+
  facet_wrap(~pcr_primers)+
  coord_fixed()+
  scale_color_brewer(palette = "Paired")+
  base_theme +
  theme(
        panel.spacing.x = unit(1, "lines"),
        legend.position = "right",
        legend.text = element_text(face = "italic", size=10)
    ) +
   labs(x = "log-odds(Predicted proportion)", 
     y = "log-odds(Observed proportion)",
     colour = "Taxon") 


gg.bias_fits

# Write out bias explained for supplementary 
pdf(file="fig/supplementary/bias_model_fit.pdf", width = 8, height = 6 , paper="a4r")
  plot(gg.bias_fits)
try(dev.off(), silent=TRUE)

# Plot bias estimates
gg.bias <- preds %>%
  ungroup() %>%
  dplyr::select(taxon, estimate, upper, lower, pcr_primers) %>%
  distinct()%>%
  left_join(mock_tree$data %>% dplyr::mutate(taxon = label %>% str_replace(" ", "_"))) %>%
  mutate(taxon = taxon %>% 
           str_replace("^Drosophila_", "D. ")%>%
           str_replace("^Scaptodrosophila_", "Sca. ")) %>%
  mutate(taxon = factor(taxon))%>%
  ggplot(aes(x = fct_reorder(taxon, y), y = estimate, colour = pcr_primers, group = pcr_primers)) +
  geom_hline(yintercept = 1, alpha=0.5, colour = "grey20") +
  geom_pointrange(aes(ymin = lower, ymax = upper), position=position_dodge(width=0.6))+
  #coord_flip() +
  scale_y_log10()+
  #facet_grid(pcr_primers~.) +
  base_theme+
  scale_colour_brewer(palette="Paired") +
  labs(
    x = NULL,
    colour="PCR primers",
    y = "Efficiency / Geometric mean") +
  theme(axis.text.x = element_text(face = "italic"),
        legend.position = "bottom")

gg.bias

#bias is missing for BF1 biarmipes because it was low reads
```

## Multifig1

Comparison of primers for bias, off-target amp, and PCA of overlap

```{r run 1 multifig}
fig1a <- mock_tree + gg.run1_heatmap + plot_layout(widths = c(1,6))

fig1 <- fig1a / gg.bias + plot_layout(heights = c(2,1))+ plot_annotation(tag_levels = 'A') & theme(plot.margin = unit(c(1,1,1,1), "mm"))

fig1
# Write out figure 1
pdf(file="fig/Fig1_primer_comparison.pdf", width = 11, height = 8 , paper="a4r")
  plot(fig1)
try(dev.off(), silent=TRUE)
```

# Supplementary Comparison of primer replicates for detection and bias

Run 2 - see the differences in bias between replicates

```{R run2}
# RUN 2
ps_run2 <- readRDS("output/rds/ps_idtaxaExact.rds") %>%
  subset_samples(fcid %in% c("CK3HD")) %>%
  filter_taxa( function(x) mean(x) > 0, TRUE) %>%
  speedyseq::tax_glom(taxrank="Species")

exp <- read_csv("sample_data/expected_quant_merged.csv") %>%
  dplyr::rename(sample_name = Sample) %>%
  pivot_longer(-sample_name,
               names_to= "taxon",
               values_to= "expected") %>%
  mutate(taxon = str_replace(taxon, pattern="_",replacement=" "),
         sample_name = str_remove(sample_name, "-exp*.$")) %>%
  dplyr::filter(!is.na(sample_name),
  !str_detect(sample_name, "CM[0-9]|CT[0-9]|CML[0-9]|Syn"),
  expected > 0) %>%
  distinct()

#Get observed

sam <- ps_run2%>%
  speedyseq::psmelt() %>%
  janitor::clean_names() %>%
  mutate(taxon = species) %>%
  filter(!str_detect(genus, "__")) %>%#Remove unclassified
  dplyr::select(sample_name, sample_id, amp_rep, taxon, abundance, pcr_primers, fcid, material_type = type) %>%
  mutate(sample_name = sample_name %>%
           str_remove_all("BF1-BR1-|SauronS878-HexCOIR4-|fwhF2-HexCOIR4-|fwhF2-fwhR2n-") %>%
           str_remove_all("HLVKYDMXX_|CK3HD_|CB3DR_|CJKFJ_"))

#Join tables 
joint <- sam %>%
  filter(taxon %in% exp$taxon,
         sample_name %in% exp$sample_name,
         abundance > 0) %>%
  left_join(exp, by = c("sample_name","taxon")) %>%
  dplyr::rename(observed = abundance) %>%
  mutate(expected = replace_na(expected, 0),
         observed0 = (observed + 0.5) * (expected > 0),
         error = observed0 / expected) %>%
  distinct() %>%
  group_by(sample_id) %>%
  mutate_at(vars(observed, expected), ~ . / sum(.) ) %>% #Convert to proportions
  ungroup() %>%
  group_by(sample_id) %>%
  group_modify(~{
    clr_denom <- .x %>%
      pull(error) %>%
      gm_mean(na.rm = TRUE)
    .x %>%
      mutate(error_clr = log(error / clr_denom))
  })

# Bootstrap estimation
set.seed(606)
boot_models <- joint %>%
  filter(material_type=="DrosMock") %>%
  filter(expected > 0) %>%
  group_by(pcr_primers, amp_rep) %>%
  group_modify(~{
    bootstraps(.x, times=1000, apparant=TRUE)  %>%
    mutate(fit =  purrr::map(splits, ~lm(error_clr ~ 0 + taxon , data = .)), 
           coef =  purrr::map(fit, function(x){
             broom::tidy(x) %>% 
               mutate(estimate = exp(estimate))})) %>%
    int_pctl(coef) %>%
    mutate(taxon = str_remove(term, "taxon"))
    }) %>%
  dplyr::select(pcr_primers, amp_rep, taxon, lower = .lower, estimate = .estimate, upper = .upper)

# See how well bias estiamte fits data
preds <- joint %>%
  left_join(boot_models) %>%
  dplyr::mutate(predicted = expected * estimate) %>%
  group_by(sample_id) %>%
  mutate_at(vars(predicted), ~ . / sum(., na.rm=TRUE) ) %>%
  filter(expected > 0) %>%
  filter(observed > 0)

# Plot bias estimates for the 3 separate primers
gg.biasreps <- preds %>%
  filter(pcr_primers == "fwhF2-fwhR2n")%>%
  ungroup() %>%
  dplyr::select(taxon, estimate, upper, lower, pcr_primers, amp_rep) %>%
  distinct()%>%
  mutate(amp_rep = factor(amp_rep, levels = c("1","2","3"))) %>%
  mutate(taxon = str_replace(taxon, "^.*_", "D. ")) %>%
  ggplot(aes(x = taxon, y = estimate, colour = amp_rep, group =amp_rep)) +
  geom_hline(yintercept = 1, alpha=0.5, colour = "grey20") +
  geom_pointrange(aes(ymin = lower, ymax = upper), position=position_dodge(width=0.5))+
  #facet_grid(~pcr_primers) +
  coord_flip() +
  base_theme+
  scale_y_log10()+
  scale_colour_brewer(palette="Paired") +
  labs(
    x = NULL,
    y = "Efficiency / Geometric mean",
    colour = "Tagged PCR primer") +
  theme(axis.text.y = element_text(face = "italic"),
        legend.position = "bottom")

gg.biasreps

# Write supplementary figure
pdf(file="fig/supplementary/run2_biasreps.pdf", width = 6, height = 4 , paper="a4r")
  plot(gg.biasreps)
try(dev.off(), silent=TRUE)
```

# Trap catch & Diversity

## Insects trapped

```{r Trapped insects}
trapdat <- read_csv("Fieldwork/trap_data_clean.csv") %>%
  janitor::clean_names()%>%
  mutate(catch = as.numeric(catch)) %>%
  mutate(orchard_type = case_when(
         str_detect(fruit, "Peach") ~ "Stonefruit",
         str_detect(fruit, "Nectarine") ~ "Stonefruit",
         str_detect(fruit, "Stonefruit") ~ "Stonefruit",
         str_detect(fruit, "Cherries") ~ "Cherries",
         TRUE ~ "Cherries"
  )) %>%
  mutate(type = case_when(
    attractant == "Dong Cha" ~ "DC",
    attractant == "ACV" ~ "ACV",
    attractant== "P glycol" ~ "SPD",
    attractant== "FF" ~ "FF"
  )) %>%
  mutate() %>%
  dplyr::filter(!attractant=="Sachet") %>%
  dplyr::select(-treatment, -attractant) %>%
  mutate(type = factor(type, levels =  c("ACV","DC", "SPD", "FF"))) 


# Total catch
trapdat %>%
  group_by(week, type, orchard, orchard_type) %>%
  dplyr::summarise(catch = sum(catch, na.rm=TRUE))
  
# By orchard
trapdat %>%
  group_by(orchard) %>%
  dplyr::summarise(catch = sum(catch, na.rm=TRUE))

# By treatment
trapdat %>%
  group_by(type) %>%
  dplyr::summarise(catch = sum(catch, na.rm=TRUE))

##Total catch by orchard and week
gg.trapweek <- trapdat %>% 
  mutate(week = as.factor(week)) %>%
  ggplot(aes(x=week, y=catch, colour=type, group=week))+
  geom_jitter(size=1, alpha=0.6, width=0.2, height=0.2)+
  geom_boxplot(fill=NA, outlier.colour = NA)+
  facet_grid(type~orchard_type, scales="free") +
  base_theme +
  scale_colour_brewer(palette="Paired") 

##Total catch by orchard and trap type
gg.trapall <- trapdat %>% 
  #mutate(grouping = paste0(type, "_", orchard_type)) %>%
  ggplot(aes(x=type, y=catch, colour=type, shape=orchard_type, group=type))+
  geom_point(size=1, alpha=0.6, position= position_jitter(width=0.2, height=0.2))+
  geom_boxplot(fill=NA, outlier.colour = NA)+
  facet_grid(orchard_type~.) +
  base_theme +
  scale_colour_brewer(palette="Paired")  + 
  labs(x = "Collection method",
       y = "Number Individuals")


gg.trapall
```

## Subset to just run 3

```{r subset}
ps2 <- readRDS("output/rds/ps_filtered.rds")
ps_run3 <- ps2 %>%
  subset_samples(fcid %in% c("HLVKYDMXX")) %>%
  subset_taxa(Phylum =="Arthropoda") %>%
  #prune_taxa(!str_detect(Species, "Synthetic")) %>%
  filter_taxa( function(x) mean(x) > 0, TRUE)

ps_run3 <-  prune_samples(sample_sums(ps_run3) > 0 , ps_run3)

# Need to remove synthetics
```


## Number of species

```{r summarise taxa}
spp_stat <- speedyseq::psmelt(ps_run3) %>%
  mutate(comm = case_when(
    type %in% c("ACV", "DC", "FF", "SPD") ~ "Field",
    type %in% c("DrosLarv", "DrosMock") ~ "Mock",
    TRUE ~ type
    )) %>%
  filter(Abundance > 0 ) %>%
  mutate(Genus = case_when(
    str_detect(Genus, "__") ~ as.character(NA),
    TRUE  ~ Species
  )) %>%
  mutate(Species = case_when(
    str_detect(Species, "__") ~ as.character(NA),
    TRUE ~ Species
  )) 

# N ASVs and samples
spp_stat %>%
  group_by(comm) %>%
  summarise(n_extracts = n_distinct(extract_id), n_samples = n_distinct(sample_id), n_asv = n_distinct(OTU), n_spp = n_distinct(Species), n_genus = n_distinct(Genus))


# Spread of Species across different types
spp_stat %>%
  group_by(extract_id, type) %>%
  dplyr::filter(Abundance > 0) %>%
  summarise(counts = n_distinct(Species)) %>%
  ungroup() %>%
  group_by(type) %>%
  summarise(mean = mean(counts), 
            se = sd(counts)/sqrt(length(counts)),
            max = max(counts),
            min = min(counts))

# Number of species for each order
ps_run3 %>%
  speedyseq::psmelt() %>%
  group_by(Order) %>%
  summarise(n = n_distinct(Species))

# Number of species for each genus
ps_run3 %>%
  speedyseq::psmelt() %>%
  group_by(Genus) %>%
  summarise(n = n_distinct(Species)) %>%
  arrange(-n)

# Number of species for each order, seperated by classified
ps_run3 %>%
  speedyseq::psmelt() %>%
  mutate(not_spp = case_when(
    str_detect(Species, "__") ~ TRUE,
    TRUE ~ FALSE
  )) %>%
  group_by(Order, not_spp) %>%
  summarise(n = n_distinct(Species))

```

## Alpha diversity metrics

```{r alpha div}
dir.create("output/alpha")

# Get a histogram of taxon sums
taxa_sums(ps_run3) %>%
  as_tibble(rownames = "OTU") %>%
  filter(value > 0) %>%
  ggplot(aes(x = value)) +
  geom_histogram() 

# Get richness measures
richness <- phyloseq::estimate_richness(ps_run3, measures=c("Chao1", "Shannon", "Simpson")) %>% #
  rownames_to_column("sample_name") %>%
  mutate(sample_name = str_replace(sample_name, "\\.", "-"))

#Richness is giving a warning because its acting on the trimemd dataset

#Set number of randomisations for calculating significance
# Calculate Faith's PD-index & Species richness - with Standard errors
sespd <- picante::ses.pd(as(phyloseq::otu_table(ps_run3), "matrix"),  phyloseq::phy_tree(ps_run3), null.model = "taxa.labels", include.root = F, runs = 9)

# Join together
div_table <- sespd %>%
  rownames_to_column("sample_name") %>%
  dplyr::select(sample_name, ntaxa, pd.obs) %>%
  dplyr::rename(pd = pd.obs, alpha = ntaxa) %>%
  left_join(richness, by="sample_name") %>%
  left_join(sample_data(ps_run3) %>% 
              as("data.frame") %>%
              filter(!duplicated(sample_id)) %>%
              dplyr::select(amp_rep, sample_name = sample_id, type),
            by = "sample_name")  %>%
  mutate(orchard = case_when(
    str_detect(sample_name, "_M[0-9]") ~ "Cherry",
    str_detect(sample_name, "_T[0-9]") ~ "Stonefruit"
  ))

# Filter to just the field collected types
div_table <- div_table %>%
  filter(type %in% c("DC", "ACV", "FF", "SPD"))

# Summarise means
div_table %>%
  summarise(across(where(is.numeric), mean, na.rm=TRUE))

# Difference in alpha diversity between trap types
report::report(aov(alpha ~type, data=div_table))
broom::tidy(TukeyHSD(aov(alpha ~type, data=div_table)))

report::report(aov(Shannon ~type, data=div_table))
broom::tidy(TukeyHSD(aov(Shannon ~type, data=div_table)))

report::report(aov(pd ~type, data=div_table))
broom::tidy(TukeyHSD(aov(pd ~type, data=div_table)))

alpha_results <- bind_rows(
  broom::tidy(TukeyHSD(aov(alpha ~type, data=div_table))) %>% mutate(metric = "richness"),
  broom::tidy(TukeyHSD(aov(Shannon ~type, data=div_table))) %>% mutate(metric = "shannon"),
  broom::tidy(TukeyHSD(aov(pd ~type, data=div_table))) %>% mutate(metric = "phylogenetic")
)

write_csv(alpha_results, "output/alpha/alpha_anova.csv")

# Differences in orchards
report::report(aov(alpha ~orchard, data=div_table))
broom::tidy(TukeyHSD(aov(alpha ~orchard, data=div_table)))

report::report(aov(Shannon ~orchard, data=div_table))
broom::tidy(TukeyHSD(aov(Shannon ~orchard, data=div_table)))

report::report(aov(pd ~orchard, data=div_table))
broom::tidy(TukeyHSD(aov(pd ~orchard, data=div_table)))

# plot differences in alpha diversity
gg.alpha <- div_table %>% 
  pivot_longer(2:7,
               names_to="metric",
               values_to="value") %>%
  filter(metric %in% c("alpha", "pd", "Shannon")) %>%
  mutate(metric = metric %>% 
           str_replace("alpha", "ASV Richness") %>%
           str_replace("pd", "Phylogenetic Diversity") %>%
           str_replace("Shannon", "Shannon Index")) %>%
  mutate(type = factor(type, levels =  c("ACV","DC", "SPD", "FF"))) %>%
  ggplot(aes(x=type, y=value, colour=type, shape=orchard, group=type)) +
  geom_jitter(size=1, alpha=0.6, width=0.2, height=0)+
  geom_boxplot(fill=NA, outlier.color = NA)+
  scale_y_continuous(position = "right")+
  #coord_flip()+
  base_theme+
  scale_colour_brewer(palette="Paired") +
  facet_wrap(.~metric,ncol=1, scales="free") +
  labs(x = "Collection method",
       y = NULL)

gg.alpha

pdf(file="fig/supplementary/trap_catches.pdf", width = 8, height = 6 , paper="a4r")
  plot(gg.trapweek)
  plot(gg.trapall)
  plot(gg.alpha)
try(dev.off(), silent=TRUE)

```

## Alpha diversity rarefied

```{r alpha div rarefied}
dir.create("output/alpha_rarefied")

# Get a histogram of sample sums to choose rarefaction depth
sample_sums(ps_run3) %>%
  as_tibble(rownames = "sample") %>%
  filter(value > 0) %>%
  ggplot(aes(x = value)) +
  geom_histogram() +
  scale_x_continuous(labels = scales::label_number_si()) +
  labs(x = "Sequence Reads",
       y = "Number of samples")

# Choose a depth to rarefy to (everything under this will be discarded)
raredepth <- 100000

# Plot a rarefaction curve to see which samples would be lost at this depth
rare <- otu_table(ps_run3) %>%
  as("matrix") %>%
  rarecurve(step=10000) %>% # Change this to be higher if you have heaps of reads to make it faster
  purrr::map_dfr(., function(x){
  b <- as.data.frame(x)
  b <- data.frame(OTU = b[,1], count = rownames(b))
  b$count <- as.numeric(gsub("N", "",  b$count))
  nm <- names(attr(x, "Subsample"))
  b$sample_id <- nm[!nm==""]
  return(b)
  })%>%
  left_join(sample_data(ps_run3)%>%
    as("matrix") %>%
    as_tibble() %>%
      dplyr::select(sample_id, fcid) %>%
      distinct())

gg.rare <- rare %>%
  ggplot() +
  geom_line(aes(x = count, y = OTU, group=sample_id), alpha=0.5)+
  geom_point(data = rare %>% 
               group_by(sample_id) %>% 
               top_n(1, count),
             aes(x = count, y = OTU, colour=(count > raredepth))) +
  scale_x_continuous(labels =  scales::label_number_si()) +
  geom_vline(xintercept=raredepth, linetype="dashed") +
  facet_wrap(fcid~., scales="free", ncol=1)+
  theme(legend.position = "bottom")+
  labs(x = "Sequence reads",
       y = "Observed ASV's",
       colour = "Sample retained?") 

gg.rare

# Rarefy (make sure to set the rngseed for reproducability)
ps_rare <- rarefy_even_depth(ps_run3, sample.size = raredepth,
  rngseed = 532251, replace = TRUE, trimOTUs = TRUE, verbose = TRUE)

rarestats <- speedyseq::psmelt(ps_rare)
  
# Get Alpha diversity measures
richness_rare <- phyloseq::estimate_richness(ps_rare, measures=c("Chao1", "Shannon", "Simpson")) %>% 
  rownames_to_column("sample_id")

# Calculate Faith's phylogenetic diversity
sespd_rare <- picante::ses.pd(as(phyloseq::otu_table(ps_rare), "matrix"),  phyloseq::phy_tree(ps_rare), null.model = "taxa.labels", include.root = F, runs = 9)

# Join together
div_table_rare <- sespd_rare %>%
  rownames_to_column("sample_id") %>%
  dplyr::select(sample_id, ntaxa, pd.obs) %>%
  dplyr::rename(pd = pd.obs, alpha = ntaxa) %>%
  left_join(richness_rare, by="sample_id") %>%
  left_join(sample_data(ps_rare) %>% 
              as("data.frame"),
            by = "sample_id") 

div_table_rare <- div_table_rare %>%
  filter(type %in% c("DC", "ACV", "FF", "SPD"))

# Summarise mean diversity
div_table_rare %>%
  summarise(across(c("alpha", "pd", "Chao1", "se.chao1", "Shannon", "Simpson"), mean, na.rm=TRUE))

# Difference in alpha diversity between a factor
# In this case we are going to use sample_name as that factor
report::report(aov(alpha ~type, data=div_table_rare))
broom::tidy(TukeyHSD(aov(alpha ~type, data=div_table_rare)))

report::report(aov(Shannon ~type, data=div_table_rare))
broom::tidy(TukeyHSD(aov(Shannon ~type, data=div_table_rare)))

report::report(aov(pd ~type, data=div_table_rare))
broom::tidy(TukeyHSD(aov(pd ~type, data=div_table_rare)))

# plot differences in alpha diversity
gg.alpha_rare <- div_table %>% 
  pivot_longer(2:7,
               names_to="metric",
               values_to="value") %>%
  filter(metric %in% c("alpha", "pd", "Shannon")) %>%
  mutate(metric = metric %>% 
           str_replace("alpha", "ASV Richness") %>%
           str_replace("pd", "Phylogenetic Diversity") %>%
           str_replace("Shannon", "Shannon Index")) %>%
  mutate(type = factor(type, levels =  c("ACV","DC", "SPD", "FF"))) %>%
  ggplot(aes(x=type, y=value, colour=type)) +
  geom_jitter(size=2, alpha=0.6, width=0.2, height=0)+
  geom_boxplot(fill=NA, outlier.colour = NA)+
  #coord_flip()+
  base_theme+
  scale_colour_brewer(palette="Paired") +
  facet_wrap(.~metric,ncol=1, scales="free")

gg.alpha_rare

# Write out results as a CSV
alpha_results_rare <- bind_rows(
  broom::tidy(TukeyHSD(aov(alpha ~type, data=div_table_rare))) %>% mutate(metric = "richness"),
  broom::tidy(TukeyHSD(aov(Shannon ~type, data=div_table_rare))) %>% mutate(metric = "shannon"),
  broom::tidy(TukeyHSD(aov(pd ~type, data=div_table_rare))) %>% mutate(metric = "phylogenetic")
)

write_csv(alpha_results, "output/alpha_rarefied/alpha_anova.csv")
```

## Beta diversity metrics

```{r Distances}
#Subset to remove mocks
ps_traps <- ps_run3 %>%
  subset_samples(!type %in% c("DrosMock", "DrosLarv", "ACV")) %>%
  filter_taxa( function(x) mean(x) > 0, TRUE)

# Get OTU tables
otutab <- ps_traps %>%
  otu_table() %>%
  as("matrix")

colSums(otutab) > 0

#Impute zeroes for compositional distances
otutab_n0 <- as.matrix(zCompositions::cmultRepl(otutab, method="CZM", output="p-counts"))
#Root phylogenetic tree
phy_tree(ps_traps) <- multi2di(phy_tree(ps_traps))
phy_tree(ps_traps) <- makeNodeLabel(phy_tree(ps_traps), method="number", prefix='n')
name.balance(phy_tree(ps_traps), tax_table(ps_traps), 'n1') #Get root

#Calculate different distance metrics
distlist <- vector("list")

distlist$Jaccard <- as.matrix(vegdist(otutab, method="jac",binary = T))
distlist$Bray <- as.matrix(vegdist(otutab, method="bray"))
distlist$Aitchison <- as.matrix(vegdist(CoDaSeq::codaSeq.clr(otutab_n0), method="euclidean"))
distlist$Philr <- as.matrix(vegdist(philr::philr(otutab_n0, phy_tree(ps_traps),
                                                part.weights='enorm.x.gm.counts',
                                                ilr.weights='blw.sqrt'), method="euclidean"))
distlist$Unifrac <- as.matrix(phyloseq::UniFrac(ps_traps, weighted=FALSE, parallel = TRUE))
distlist$WUnifrac <- as.matrix(phyloseq::UniFrac(ps_traps, weighted=TRUE, parallel = TRUE))

#Add rarefied metrics
ps_traps_rare <- ps_rare %>%
  subset_samples(!type %in% c("DrosMock", "DrosLarv", "ACV")) %>%
  filter_taxa( function(x) mean(x) > 0, TRUE)

# Get OTU tables
otutab_rare <- ps_traps_rare %>%
  otu_table() %>%
  as("matrix")

#Impute zeroes for compositional distances
otutab_n0_rare <- as.matrix(zCompositions::cmultRepl(otutab_rare, method="CZM", output="p-counts"))
#Root phylogenetic tree
phy_tree(ps_traps_rare) <- multi2di(phy_tree(ps_traps_rare))
phy_tree(ps_traps_rare) <- makeNodeLabel(phy_tree(ps_traps_rare), method="number", prefix='n')
name.balance(phy_tree(ps_traps_rare), tax_table(ps_traps_rare), 'n1') #Get root

distlist$Jaccard_rare <- as.matrix(vegdist(otutab_rare, method="jac",binary = T))
distlist$Bray_rare <- as.matrix(vegdist(otutab_rare, method="bray"))
distlist$Aitchison_rare <- as.matrix(vegdist(CoDaSeq::codaSeq.clr(otutab_n0_rare), method="euclidean"))
distlist$Philr_rare <- as.matrix(vegdist(philr::philr(otutab_n0_rare, phy_tree(ps_traps_rare),
                                                part.weights='enorm.x.gm.counts',
                                                ilr.weights='blw.sqrt'), method="euclidean"))
distlist$Unifrac_rare <- as.matrix(phyloseq::UniFrac(ps_traps_rare, weighted=FALSE, parallel = TRUE))
distlist$WUnifrac_rare <- as.matrix(phyloseq::UniFrac(ps_traps_rare, weighted=TRUE, parallel = TRUE))

```

# Adonis and betadisper

```{r betatest}
# Adonis test
metadata <- sample_data(ps_traps_rare) %>%
  as("data.frame")%>%
  mutate(orchard = case_when(
    str_detect(sample_id, "_M[0-9]") ~ "Cherry",
    str_detect(sample_id, "_T[0-9]") ~ "Stonefruit"
  ))

# Test difference by community type
adonis_results <- distlist %>%
  purrr::map(function(x) {
    bind_rows(
    broom::tidy(adonis(x~type, method="euclidean", data=metadata)$aov.tab) %>% mutate(comparison = "type"),
    broom::tidy(adonis(x~orchard, method="euclidean", data=metadata)$aov.tab) %>% mutate(comparison = "orchard")
    )
})  %>%
  bind_rows(.id="dist")

# Check homogeneity
betadisper_results <- distlist %>%
  purrr::map(function(x) {
    y <- as.dist(x[metadata$sample_id, metadata$sample_id])
  bind_rows(
    as.data.frame(permutest(vegan::betadisper(y, metadata$type))$tab) %>%
      mutate(term="type"),
    as.data.frame(permutest(vegan::betadisper(y, metadata$orchard))$tab) %>%
      mutate(term="orchard")

  )
})  %>%
  bind_rows(.id="dist")

dir.create("output/beta")
write_csv(adonis_results, "output/beta/adonis.csv")
write_csv(betadisper_results, "output/beta/adonis.csv")

#Plot betadispersal
z <- as.dist(distlist$Unifrac_rare[metadata$sample_id, metadata$sample_id])
orchard_dispnest <- vegan::betadisper(z, metadata$orchard)
plot(orchard_dispnest)

sample_dispnest <- vegan::betadisper(z, metadata$type)
plot(sample_dispnest)

```

# PCA plots

```{r pca plots}
# Get distance
plot_dist <- as.dist(distlist$Unifrac_rare)

plot_pcoa <- ordinate(ps_traps_rare, 'PCoA', distance=plot_dist)

sample_data(ps_traps_rare) <- sample_data(ps_traps_rare) %>%
  as("matrix") %>%
  as_tibble(rownames="sample") %>%
  mutate(orchard = case_when(
    str_detect(sample_id, "_M[0-9]") ~ "Cherry",
    str_detect(sample_id, "_T[0-9]") ~ "Stonefruit"
  )) %>%
  column_to_rownames("sample")
  
gg.pca <- plot_ordination(ps_traps_rare, plot_pcoa, color = "type", shape="orchard") +
  stat_ellipse(geom = "polygon", aes(group = orchard, fill=orchard, colour=orchard), alpha=0.05) +
  scale_fill_viridis_d()+
  scale_colour_viridis_d()+
   new_scale_fill() +
  new_scale_colour() +
  geom_point(size=4, alpha=1, aes(colour=type, shape=orchard)) +
  stat_ellipse(geom = "polygon", aes(group = type, fill=type, colour=type), alpha=0.05) +
  scale_colour_brewer(palette="Paired") +
  scale_fill_brewer(palette="Paired") +
  geom_hline(yintercept = 0, linetype=2, alpha=0.5) +  
  geom_vline(xintercept = 0, linetype=2, alpha=0.5) +
  base_theme +
  #coord_fixed() +
  theme(legend.position = "bottom") +
  labs(colour = "Sample Type") 

gg.pca

# Heirarchial clustering
dend <- as.phylo(hclust(plot_dist, method="ward.D2"))

dend$tip.label <- dend$tip.label %>%
  str_remove("HLVKYDMXX_")
p3 <- ggtree(dend) + 
  theme_tree2()

colours_p3 <- p3$data %>%
  left_join(as_data_frame(sample_data(ps_traps_rare)) %>%
              dplyr::select(sample_id, type, orchard) %>%
  dplyr::rename(label = sample_id) %>%
    mutate(label = label %>%
  str_remove("HLVKYDMXX_"))
    )

p3 <- p3 %<+% colours_p3  + 
  geom_tippoint(aes(colour=as.factor(type), shape=as.factor(orchard)), size=3)  + 
  geom_tiplab(aes(colour=as.factor(type)))+
  scale_colour_brewer(palette="Paired") +
  theme_void()+
  scale_x_continuous(expand=c(0, 0.3)) +
  theme(legend.position = "none")

# Plot together
gg.pca_tree <- p3 + gg.pca + plot_layout(widths = c(1,2)) + plot_annotation(tag_levels = "A")

gg.pca_tree

# Write out PCA plots
pdf(file="fig/supplementary/pca_tree.pdf", width = 11, height = 8 , paper="a4r")
  plot(gg.pca_tree)
try(dev.off(), silent=TRUE)
```


# Phylogeny of trap catches

```{r Phylogeny}
taxa_names(ps_run3) <- taxa_names(ps_run3)%>% str_remove("^.*-")

tree <- phy_tree(ps_run3)

p1dat <- speedyseq::psmelt(ps_run3) %>%
  dplyr::select(sample_id, OTU, type, Abundance) %>%
  group_by(sample_id) %>%  
  mutate_at(vars(Abundance), ~ . / sum(.)) %>%
  filter(Abundance > 0) %>%
  drop_na() %>%
  dplyr::filter(type %in% c("ACV", "DC", "FF", "SPD")) %>%
  group_by(OTU, type) %>%
  summarise(Abundance = mean(Abundance)) %>%
  distinct() %>%
  pivot_wider(names_from = type,
              values_from = Abundance,
              values_fill = 0) %>%
  filter(!OTU %in% c("F__Drosophilidae", "C__Insecta")) %>%
  column_to_rownames("OTU") 

tree <- drop.tip(tree, tree$tip.label[!tree$tip.label %in% rownames(p1dat)])

circ <- ggtree(tree, layout = "circular", branch.length = 'none', aes(color=Order))

circ_dat <- circ$data %>%
  left_join(speedyseq::psmelt(ps_run3)  %>%
            dplyr::select(label = OTU, Order) %>%
              distinct() 
    )

circ <- circ %<+% circ_dat +
  scale_colour_brewer(palette="Paired",na.value="black") 


p1 <- gheatmap(circ, p1dat, offset=0, width=.4, color="gray20",
               colnames_angle=95, colnames_offset_y = 0) +
    scale_fill_viridis_c(option="D", name="Abundance", alpha=0.9, trans="log10", label= scales::percent) 

# Also try add week? and orchard?
p2dat <- speedyseq::psmelt(ps_run3) %>%
  mutate(orchard = case_when(
    str_detect(sample_name,"^T") ~ "Stonefruit",
    str_detect(sample_name,"^M") ~ "Cherries",
    TRUE ~ as.character(NA)
  )) %>%
    group_by(sample_id) %>%  
  mutate_at(vars(Abundance), ~ . / sum(.)) %>%
  dplyr::select(OTU, orchard, Abundance) %>%

    filter(Abundance > 0) %>%
  drop_na() %>%
  group_by(OTU, orchard) %>%
  summarise(Abundance = mean(Abundance)) %>%
  distinct() %>%
  pivot_wider(names_from = orchard,
              values_from = Abundance,
              values_fill = 0) %>%
  column_to_rownames("OTU")
  
p2 <- p1 + new_scale_fill()
gg.phylo <- gheatmap(p2, p2dat, offset=5.5, width=.2,
         colnames_angle=90, colnames_offset_y = .25, color="gray20") +
    scale_fill_viridis_c(option="B", name="Abundance", trans="log10", label= scales::percent)+
  geom_tiplab(offset=9, align=FALSE, size=3) +
theme(legend.position = "bottom")

gg.phylo

# FInal phylo fig
gg.Fig4a <- gg.trapall + gg.alpha
gg.Fig4 <- gg.phylo - gg.Fig4a + plot_layout(widths = c(2,1.5)) + plot_annotation(tag_levels = "A")

gg.Fig4

# Write out bias explained for supplementary 
pdf(file="fig/Fig4_diversity.pdf", width = 11, height = 8 , paper="a4r")
  plot(gg.Fig4)
try(dev.off(), silent=TRUE)
```


# Reproducability Receipt

```{details, echo = FALSE, details.summary = 'Reproducability receipt'}
# datetime
Sys.time()
#repository
git2r::repository()
sessioninfo::session_info()
```
